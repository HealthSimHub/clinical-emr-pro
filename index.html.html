<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClinicalEMR Pro</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #0f4c81;
    --primary-light: #1a6bb5;
    --primary-dark: #0a3259;
    --accent: #00b4d8;
    --accent2: #06d6a0;
    --warn: #ef476f;
    --warn-light: #fff0f3;
    --bg: #f0f4f8;
    --surface: #ffffff;
    --surface2: #f7f9fc;
    --border: #d1dce8;
    --text: #1a2b3c;
    --text2: #4a6080;
    --text3: #8099b3;
    --green: #06d6a0;
    --yellow: #ffd166;
    --red: #ef476f;
    --purple: #9b5de5;
    --sidebar-w: 200px;
    --header-h: 64px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'IBM Plex Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

  /* HEADER */
  #header {
    position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 60%, var(--primary-light) 100%);
    display: flex; align-items: center; padding: 0 20px; gap: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,.25); z-index: 100;
  }
  #header .logo { color: #fff; font-size: 18px; font-weight: 700; letter-spacing: -.5px; white-space: nowrap; }
  #header .logo span { color: var(--accent); }
  #patient-select-wrap { display: flex; align-items: center; gap: 10px; flex: 1; }
  #patient-select {
    background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.3);
    color: #fff; padding: 7px 12px; border-radius: 6px; font-size: 14px;
    font-family: inherit; cursor: pointer; min-width: 220px;
  }
  #patient-select option { background: var(--primary-dark); color: #fff; }
  .status-badge {
    padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
    letter-spacing: .5px; text-transform: uppercase; white-space: nowrap;
  }
  .status-badge.checked-in { background: var(--green); color: #fff; }
  .status-badge.checked-out { background: var(--text3); color: #fff; }
  .header-btn {
    padding: 7px 14px; border-radius: 6px; border: 1px solid rgba(255,255,255,.35);
    background: rgba(255,255,255,.15); color: #fff; cursor: pointer; font-size: 13px;
    font-family: inherit; font-weight: 500; transition: background .15s;
  }
  .header-btn:hover { background: rgba(255,255,255,.28); }

  /* LAYOUT */
  #app { display: flex; margin-top: var(--header-h); min-height: calc(100vh - var(--header-h)); }

  /* SIDEBAR */
  #sidebar {
    width: var(--sidebar-w); background: var(--primary-dark); color: #fff;
    position: fixed; top: var(--header-h); left: 0; bottom: 0;
    overflow-y: auto; display: flex; flex-direction: column; padding: 12px 0;
    z-index: 50;
  }
  .sidebar-section { padding: 8px 12px 4px; font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
  .checkin-btns { display: flex; flex-direction: column; gap: 6px; padding: 8px 12px; }
  .checkin-btn {
    padding: 8px 10px; border-radius: 6px; border: none; cursor: pointer;
    font-family: inherit; font-size: 13px; font-weight: 600; transition: all .15s;
  }
  .btn-checkin { background: var(--green); color: #fff; }
  .btn-checkout { background: var(--warn); color: #fff; }
  .checkin-btn:hover { opacity: .85; transform: translateY(-1px); }
  .sidebar-divider { height: 1px; background: rgba(255,255,255,.1); margin: 8px 12px; }
  .nav-item {
    display: block; padding: 8px 16px; color: rgba(255,255,255,.75); text-decoration: none;
    font-size: 13px; cursor: pointer; border-left: 3px solid transparent;
    transition: all .15s; user-select: none;
  }
  .nav-item:hover { color: #fff; background: rgba(255,255,255,.08); }
  .nav-item.active { color: #fff; background: rgba(255,255,255,.13); border-left-color: var(--accent); font-weight: 600; }

  /* MAIN CONTENT */
  #main { margin-left: var(--sidebar-w); flex: 1; padding: 24px; min-height: calc(100vh - var(--header-h)); }

  /* SECTION */
  .section { display: none; }
  .section.active { display: block; }
  .section-title { font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 18px; display: flex; align-items: center; gap: 10px; }
  .section-title .icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; }

  /* CARDS */
  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 18px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,.06);
  }
  .card-title { font-size: 13px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 12px; }
  .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
  .field-group { display: flex; flex-direction: column; gap: 3px; }
  .field-label { font-size: 11px; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: .4px; }
  .field-value { font-size: 14px; color: var(--text); font-weight: 500; }

  /* FORMS */
  .form-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
  label { font-size: 12px; font-weight: 600; color: var(--text2); }
  input, select, textarea {
    padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
    font-family: inherit; font-size: 14px; color: var(--text);
    background: var(--surface2); transition: border-color .15s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); background: #fff; }
  textarea { resize: vertical; min-height: 80px; }

  /* BUTTONS */
  .btn {
    padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;
    font-family: inherit; font-size: 13px; font-weight: 600; transition: all .15s;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: var(--primary-light); }
  .btn-success { background: var(--green); color: #fff; }
  .btn-success:hover { opacity: .85; }
  .btn-danger { background: var(--warn); color: #fff; }
  .btn-danger:hover { opacity: .85; }
  .btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  .btn-xs { padding: 3px 7px; font-size: 11px; }

  /* TABLES */
  table { width: 100%; border-collapse: collapse; }
  th { background: var(--surface2); padding: 9px 12px; text-align: left; font-size: 11px; color: var(--text3); font-weight: 700; text-transform: uppercase; letter-spacing: .4px; border-bottom: 2px solid var(--border); }
  td { padding: 9px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* BADGES */
  .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; }
  .badge-green { background: #d4f8ed; color: #047857; }
  .badge-yellow { background: #fff7d6; color: #92400e; }
  .badge-red { background: #fee2e8; color: #9f1239; }
  .badge-blue { background: #dbeafe; color: #1e40af; }
  .badge-purple { background: #ede9fe; color: #6d28d9; }
  .badge-gray { background: #f1f5f9; color: #475569; }

  /* NOTIFICATION */
  #toast {
    position: fixed; bottom: 20px; right: 20px; background: var(--primary-dark);
    color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 14px;
    opacity: 0; transition: opacity .3s; z-index: 1000; pointer-events: none;
    box-shadow: 0 4px 16px rgba(0,0,0,.2);
  }
  #toast.show { opacity: 1; }

  /* INLINE CONFIRM */
  .confirm-box {
    background: var(--warn-light); border: 1px solid var(--warn); border-radius: 8px;
    padding: 12px 16px; display: flex; align-items: center; gap: 12px;
    margin-bottom: 12px;
  }

  /* VITALS GRID */
  .vitals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
  .vital-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px; text-align: center;
  }
  .vital-card .val { font-size: 22px; font-weight: 700; color: var(--primary); font-family: 'IBM Plex Mono', monospace; }
  .vital-card .unit { font-size: 11px; color: var(--text3); }
  .vital-card .name { font-size: 12px; color: var(--text2); font-weight: 600; margin-bottom: 4px; }

  /* ORDER STATUS */
  .order-pending { color: #92400e; }
  .order-inprogress { color: #1e40af; }
  .order-completed { color: #047857; }

  /* PROGRESS BAR */
  .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--green); border-radius: 4px; transition: width .3s; }

  /* CHECKOUT */
  .checkout-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .checkout-row.total { font-weight: 700; font-size: 16px; border-bottom: none; padding-top: 14px; }

  /* PRINT */
  @media print {
    #header, #sidebar, .no-print { display: none !important; }
    #main { margin: 0; padding: 10px; }
    .section { display: block !important; }
    .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
    body { font-size: 12px; }
  }

  /* TABS for sub-sections */
  .tab-row { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
  .tab-btn {
    padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text2); cursor: pointer; font-size: 12px; font-weight: 600;
    transition: all .15s;
  }
  .tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

  input[type="checkbox"] {
    width: 15px;
    height: 15px;
    min-width: 15px;
    min-height: 15px;
    margin: 0;
    cursor: pointer;
    accent-color: var(--primary);
    flex-shrink: 0;
    display: block;
  }
  .ros-label, .pe-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    cursor: pointer;
    font-size: 13px;
    line-height: 1.2;
    user-select: none;
  }
  .ros-label:hover, .pe-label:hover {
    color: var(--primary);
  }
  .gap-8 { gap: 8px; }
  .gap-12 { gap: 12px; }
  .mt-8 { margin-top: 8px; }
  .mt-12 { margin-top: 12px; }
  .mt-16 { margin-top: 16px; }
  .mb-8 { margin-bottom: 8px; }
  .ml-auto { margin-left: auto; }
  .text-right { text-align: right; }
  .text-sm { font-size: 12px; }
  .text-muted { color: var(--text3); }
  .font-mono { font-family: 'IBM Plex Mono', monospace; }
  .w-full { width: 100%; }
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div style="display:flex;flex-direction:column;gap:1px">
    <div class="logo">Clinical<span>EMR</span> Pro</div>
    <div style="font-size:10px;color:rgba(255,255,255,.45);letter-spacing:.3px">¬© 2025 HealthSim Hub. All rights reserved. ¬∑ This material may not be reproduced, distributed, or used without written permission.</div>
  </div>
  <div id="patient-select-wrap">
    <select id="patient-select" onchange="selectPatient(this.value)">
      <option value="">-- Select Patient --</option>
    </select>
    <span id="checkin-badge" class="status-badge checked-out">Checked Out</span>
  </div>
  <button class="header-btn no-print" onclick="showAddPatientModal()">+ Add Patient</button>
  <button class="header-btn no-print" onclick="printRecord()">üñ® Print</button>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <nav id="sidebar">
    <div class="sidebar-section">Actions</div>
    <div class="checkin-btns">
      <button class="checkin-btn btn-checkin" onclick="doCheckin()">‚úì Check In</button>
      <button class="checkin-btn btn-checkout" onclick="doCheckout()">‚úó Check Out</button>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">Chart</div>
    <div class="nav-item active" onclick="showSection('patient-details')">üë§ Patient Details</div>
    <div class="nav-item" onclick="showSection('visit-history')">üìã Visit History</div>
    <div class="nav-item" onclick="showSection('problem-list')">‚öï Problem List</div>
    <div class="nav-item" onclick="showSection('vital-signs')">üíì Vital Signs</div>
    <div class="nav-item" onclick="showSection('allergies-meds')">üíä Allergies & Meds</div>
    <div class="nav-item" onclick="showSection('clinical-notes')">üìù Clinical Notes</div>
    <div class="nav-item" onclick="showSection('orders')">üìã Orders & Workflow</div>
    <div class="nav-item" onclick="showSection('lab-results')">üî¨ Results</div>
    <div class="nav-item" onclick="showSection('lab-procedures')">üß™ Labs & Procedures</div>
    <div class="nav-item" onclick="showSection('appointments')">üìÖ Appointments</div>
    <div class="nav-item" onclick="showSection('encounter-form')">üìÑ Encounter Form</div>
    <div class="nav-item" onclick="showSection('requisitions')">‚úÖ Requisitions</div>
    <div class="nav-item" onclick="showSection('visit-charges')">üí∞ Visit Charges</div>
    <div class="nav-item" onclick="showSection('checkout')">üèÅ Checkout</div>
  </nav>

  <!-- MAIN -->
  <main id="main">

    <!-- PATIENT DETAILS -->
    <div class="section active" id="section-patient-details">
      <div class="section-title">üë§ Patient Details</div>
      <div id="patient-details-content">
        <p class="text-muted">Please select a patient.</p>
      </div>
    </div>

    <!-- VISIT HISTORY -->
    <div class="section" id="section-visit-history">
      <div class="section-title">üìã Visit History</div>
      <div class="card">
        <div class="card-title">Past Visits</div>
        <div id="visit-history-table"></div>
      </div>
    </div>

    <!-- PROBLEM LIST -->
    <div class="section" id="section-problem-list">
      <div class="section-title">‚öï Problem List</div>
      <div class="card no-print">
        <div class="card-title">Add New Problem</div>
        <div class="form-row">
          <div class="form-group"><label>ICD-10 Code</label><input id="problem-code" placeholder="e.g. E11.9"></div>
          <div class="form-group" style="flex:2"><label>Description</label><input id="problem-desc" placeholder="Problem description"></div>
          <div class="form-group"><label>Status</label>
            <select id="problem-status"><option>Active</option><option>Chronic</option><option>Resolved</option></select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addProblem()">+ Add Problem</button>
      </div>
      <div class="card">
        <div class="card-title">Problem List</div>
        <div id="problem-list-table"></div>
      </div>
    </div>

    <!-- VITAL SIGNS -->
    <div class="section" id="section-vital-signs">
      <div class="section-title">üíì Vital Signs</div>
      <div class="card no-print">
        <div class="card-title">Record New Vitals</div>
        <div class="form-row">
          <div class="form-group"><label>Temp (¬∞F)</label><input id="v-temp" type="number" step="0.1" placeholder="98.6"></div>
          <div class="form-group"><label>BP (Systolic)</label><input id="v-bps" type="number" placeholder="120"></div>
          <div class="form-group"><label>BP (Diastolic)</label><input id="v-bpd" type="number" placeholder="80"></div>
          <div class="form-group"><label>HR (bpm)</label><input id="v-hr" type="number" placeholder="72"></div>
          <div class="form-group"><label>RR (/min)</label><input id="v-rr" type="number" placeholder="16"></div>
          <div class="form-group"><label>Weight (lbs)</label><input id="v-wt" type="number" step="0.1" placeholder="150" oninput="calcBMI()"></div>
          <div class="form-group"><label>Height (in)</label><input id="v-ht" type="number" step="0.1" placeholder="65" oninput="calcBMI()"></div>
          <div class="form-group"><label>Vision OD (R)</label><input id="v-od" placeholder="e.g. 20/20"></div>
          <div class="form-group"><label>Vision OS (L)</label><input id="v-os" placeholder="e.g. 20/20"></div>
          <div class="form-group"><label>Corrected?</label><select id="v-corrected"><option value="">‚Äî</option><option>Uncorrected</option><option>Corrected</option></select></div>
          <div class="form-group"><label>O2 Sat (%)</label><input id="v-o2" type="number" placeholder="98"></div>
        </div>
        <div id="bmi-result" style="display:none;margin:10px 0 12px;padding:10px 14px;border-radius:8px;font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--surface2)"></div>
        <button class="btn btn-primary" onclick="saveVitals()">üíæ Save Vitals</button>
      </div>
      <div class="card" id="vitals-history-card">
        <div class="card-title">Vitals History</div>
        <div id="vitals-history-table"></div>
      </div>
    </div>

    <!-- ALLERGIES & MEDS -->
    <div class="section" id="section-allergies-meds">
      <div class="section-title">üíä Allergies & Medications</div>
      <div class="card">
        <div class="card-title">Known Allergies
          <button class="btn btn-sm btn-primary no-print ml-auto" style="float:right" onclick="toggleAllergyForm()">+ Add Allergy</button>
        </div>
        <div id="allergy-form" style="display:none; margin-bottom:12px" class="no-print">
          <div class="form-row">
            <div class="form-group"><label>Allergen</label><input id="allergy-name" placeholder="e.g. Penicillin"></div>
            <div class="form-group"><label>Reaction</label><input id="allergy-reaction" placeholder="e.g. Hives, Anaphylaxis"></div>
            <div class="form-group"><label>Severity</label>
              <select id="allergy-severity"><option>Mild</option><option>Moderate</option><option>Severe</option></select>
            </div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="addAllergy()">Save Allergy</button>
        </div>
        <div id="allergy-list"></div>
      </div>
      <div class="card">
        <div class="card-title">Current Medications
          <button class="btn btn-sm btn-primary no-print ml-auto" style="float:right" onclick="toggleMedForm()">+ Add Medication</button>
        </div>
        <div id="med-form" style="display:none; margin-bottom:12px" class="no-print">
          <div class="form-row">
            <div class="form-group" style="flex:2"><label>Medication</label><input id="med-name" placeholder="e.g. Lisinopril"></div>
            <div class="form-group"><label>Dose</label><input id="med-dose" placeholder="e.g. 10mg"></div>
            <div class="form-group"><label>Frequency</label><input id="med-freq" placeholder="e.g. Once daily"></div>
            <div class="form-group"><label>Route</label><input id="med-route" placeholder="e.g. Oral"></div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="addMed()">Save Medication</button>
        </div>
        <div id="med-list"></div>
      </div>
    </div>

    <!-- CLINICAL NOTES -->
    <div class="section" id="section-clinical-notes">
      <div class="section-title">üìù Clinical Notes</div>
      <div class="card no-print">
        <div class="card-title">Add New Note</div>
        <div class="form-row">
          <div class="form-group">
            <label>Note Type</label>
            <select id="note-type">
              <option>SOAP Note</option><option>Progress Note</option><option>Nursing Note</option>
              <option>Consultation Note</option><option>Discharge Summary</option><option>Phone Encounter</option>
            </select>
          </div>
          <div class="form-group"><label>Provider</label><input id="note-provider" placeholder="Dr. Name"></div>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label>Note Content</label>
          <textarea id="note-content" rows="5" placeholder="Enter clinical note..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addNote()">üíæ Save Note</button>
      </div>
      <div id="notes-list"></div>
    </div>

    <!-- ORDERS -->
    <div class="section" id="section-orders">
      <div class="section-title">üìã Orders & Workflow</div>
      <div class="card no-print">
        <div class="card-title">Create New Order</div>
        <div class="form-row">
          <div class="form-group">
            <label>Order Type</label>
            <select id="order-type"><option>Lab</option><option>Imaging</option><option>Procedure</option><option>Consultation</option><option>Medication</option></select>
          </div>
          <div class="form-group" style="flex:2"><label>Order Details</label><input id="order-detail" placeholder="e.g. CBC with Diff, Chest X-Ray..."></div>
          <div class="form-group"><label>Priority</label>
            <select id="order-priority"><option>Routine</option><option>Urgent</option><option>STAT</option></select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addOrder()">+ Create Order</button>
      </div>
      <div class="card">
        <div class="card-title">Active Orders</div>
        <div id="orders-list"></div>
      </div>
    </div>

    <!-- LAB RESULTS -->
    <div class="section" id="section-lab-results">
      <div class="section-title">üî¨ Results</div>
      <div class="card">
        <div class="card-title">Completed Orders</div>
        <div id="lab-results-content"></div>
      </div>
    </div>

    <!-- LABS & PROCEDURES -->
    <div class="section" id="section-lab-procedures">
      <div class="section-title">üß™ Labs & Procedures</div>
      <div class="card no-print">
        <div class="card-title">Perform Lab Procedure</div>
        <div class="form-row">
          <div class="form-group">
            <label>Test Type</label>
            <select id="lab-proc-type" onchange="renderLabProcForm()">
              <option value="">-- Select Test --</option>
              <option value="urinalysis">Urinalysis (Dipstick)</option>
              <option value="preg">Pregnancy Test (hCG)</option>
              <option value="glucose">Point-of-Care Glucose</option>
            </select>
          </div>
          <div class="form-group"><label>Performed By</label><input id="lab-proc-provider" placeholder="Provider/Tech name"></div>
        </div>
        <div id="lab-proc-form"></div>
        <button class="btn btn-primary mt-12" onclick="saveLabProc()">üíæ Save Results</button>
      </div>

      <div class="card no-print">
        <div class="card-title">Manual Result Entry</div>
        <div class="form-row">
          <div class="form-group">
            <label>Result Type</label>
            <select id="manual-result-type">
              <option>Lab</option>
              <option>Imaging</option>
              <option>Procedure</option>
              <option>Consultation</option>
              <option>Other</option>
            </select>
          </div>
          <div class="form-group" style="flex:2"><label>Test / Study Name</label><input id="manual-result-name" placeholder="e.g. CBC, Chest X-Ray, EKG..."></div>
          <div class="form-group"><label>Performed By</label><input id="manual-result-provider" placeholder="Provider/Lab name"></div>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label>Result / Findings</label>
          <textarea id="manual-result-content" rows="3" placeholder="Enter result values, findings, or interpretation..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="manual-result-status">
              <option>Final</option>
              <option>Preliminary</option>
              <option>Pending</option>
              <option>Corrected</option>
            </select>
          </div>
          <div class="form-group" style="justify-content:flex-end;align-items:flex-end">
            <button class="btn btn-primary" onclick="saveManualResult()">üíæ Save Result</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Labs & Procedure History</div>
        <div id="lab-proc-history"></div>
      </div>
    </div>

    <!-- APPOINTMENTS -->
    <div class="section" id="section-appointments">
      <div class="section-title">üìÖ Appointments</div>
      <div class="card no-print">
        <div class="card-title">Schedule New Appointment</div>
        <div class="form-row">
          <div class="form-group"><label>Date</label><input id="appt-date" type="date"></div>
          <div class="form-group"><label>Time</label><input id="appt-time" type="time"></div>
          <div class="form-group">
            <label>Type</label>
            <select id="appt-type">
              <option>New Patient</option><option>Follow-up</option><option>Annual Physical</option>
              <option>Urgent Care</option><option>Specialist Consult</option><option>Telehealth</option>
            </select>
          </div>
          <div class="form-group"><label>Provider</label><input id="appt-provider" placeholder="Provider name"></div>
        </div>
        <div class="form-group mb-8"><label>Reason for Visit</label><input id="appt-reason" placeholder="Reason for appointment"></div>
        <button class="btn btn-primary" onclick="addAppointment()">+ Schedule</button>
      </div>
      <div class="card">
        <div class="card-title">Scheduled Appointments</div>
        <div id="appointments-list"></div>
      </div>
    </div>

    <!-- ENCOUNTER FORM -->
    <div class="section" id="section-encounter-form">
      <div class="section-title">üìÑ Encounter Form</div>
      <div class="tab-row no-print" id="enc-tab-row">
        <button class="tab-btn active" id="enc-tab-standard" onclick="switchEncTab('standard')">üìã Standard Encounter</button>
        <button class="tab-btn" id="enc-tab-pediatric" onclick="switchEncTab('pediatric')" style="display:none">ü©∫ Pediatric Encounter</button>
      </div>

      <!-- STANDARD ENCOUNTER -->
      <div id="enc-standard">
      <div class="card">
        <div class="card-title">Chief Complaint</div>
        <input id="enc-cc" placeholder="Chief complaint..." style="margin-bottom:0">
      </div>
      <div class="card">
        <div class="card-title">History of Present Illness (HPI)</div>
        <textarea id="enc-hpi" rows="4" placeholder="Describe the history of present illness..."></textarea>
      </div>
      <div class="card">
        <div class="card-title">Pain Scale</div>
        <div style="margin-bottom:10px;font-size:13px;color:var(--text2)">Rate the patient's current pain level (0 = No pain, 10 = Worst imaginable)</div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="display:flex;gap:6px;">
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(0)"><input type="radio" name="pain-scale" value="0" id="pain-0"><span style="font-size:12px;color:var(--text2)">0</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(1)"><input type="radio" name="pain-scale" value="1" id="pain-1"><span style="font-size:12px;color:#22c55e">1</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(2)"><input type="radio" name="pain-scale" value="2" id="pain-2"><span style="font-size:12px;color:#4ade80">2</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(3)"><input type="radio" name="pain-scale" value="3" id="pain-3"><span style="font-size:12px;color:#a3e635">3</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(4)"><input type="radio" name="pain-scale" value="4" id="pain-4"><span style="font-size:12px;color:#facc15">4</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(5)"><input type="radio" name="pain-scale" value="5" id="pain-5"><span style="font-size:12px;color:#fb923c">5</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(6)"><input type="radio" name="pain-scale" value="6" id="pain-6"><span style="font-size:12px;color:#f97316">6</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(7)"><input type="radio" name="pain-scale" value="7" id="pain-7"><span style="font-size:12px;color:#ef4444">7</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(8)"><input type="radio" name="pain-scale" value="8" id="pain-8"><span style="font-size:12px;color:#dc2626">8</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(9)"><input type="radio" name="pain-scale" value="9" id="pain-9"><span style="font-size:12px;color:#b91c1c">9</span></label>
            <label style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer" onclick="setPain(10)"><input type="radio" name="pain-scale" value="10" id="pain-10"><span style="font-size:12px;color:#7f1d1d">10</span></label>
          </div>
          <div id="pain-display" style="font-size:15px;font-weight:700;color:var(--primary);min-width:120px"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Social History</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div>
            <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px">Tobacco Use</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px">
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="tobacco" value="Never"> Never</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="tobacco" value="Former"> Former</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="tobacco" value="Current"> Current</label>
            </div>
            <input id="tobacco-detail" placeholder="Pack/year history, quit date, etc." style="font-size:12px">
          </div>
          <div>
            <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px">Alcohol Use</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px">
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="alcohol" value="None"> None</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="alcohol" value="Social"> Social</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="alcohol" value="Moderate"> Moderate</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="alcohol" value="Heavy"> Heavy</label>
            </div>
            <input id="alcohol-detail" placeholder="Drinks per week, type, etc." style="font-size:12px">
          </div>
        </div>
        <div style="margin-top:14px">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px">Additional Social History</div>
          <div class="form-row">
            <div class="form-group"><label>Occupation</label><input id="soc-occupation" placeholder="e.g. Teacher, Retired"></div>
            <div class="form-group"><label>Living Situation</label><input id="soc-living" placeholder="e.g. Lives alone, with spouse"></div>
            <div class="form-group"><label>Exercise</label><input id="soc-exercise" placeholder="e.g. 3x/week, sedentary"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Family History</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:12px">Note significant family medical history by relation.</div>
        <div class="form-row">
          <div class="form-group"><label>Mother</label><input id="fh-mother" placeholder="e.g. HTN, DM Type 2"></div>
          <div class="form-group"><label>Father</label><input id="fh-father" placeholder="e.g. CAD, deceased at 72"></div>
          <div class="form-group"><label>Siblings</label><input id="fh-siblings" placeholder="e.g. No known conditions"></div>
          <div class="form-group"><label>Other</label><input id="fh-other" placeholder="e.g. Maternal grandmother - breast cancer"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Depression Screen (PHQ-2)</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:14px">Over the past 2 weeks, how often has the patient been bothered by the following?</div>
        <div style="margin-bottom:14px">
          <div style="font-size:13px;font-weight:600;margin-bottom:8px">1. Little interest or pleasure in doing things?</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq1" value="0" onchange="calcPHQ()"> Not at all (0)</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq1" value="1" onchange="calcPHQ()"> Several days (1)</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq1" value="2" onchange="calcPHQ()"> More than half the days (2)</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq1" value="3" onchange="calcPHQ()"> Nearly every day (3)</label>
          </div>
        </div>
        <div style="margin-bottom:14px">
          <div style="font-size:13px;font-weight:600;margin-bottom:8px">2. Feeling down, depressed, or hopeless?</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq2" value="0" onchange="calcPHQ()"> Not at all (0)</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq2" value="1" onchange="calcPHQ()"> Several days (1)</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq2" value="2" onchange="calcPHQ()"> More than half the days (2)</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="radio" name="phq2" value="3" onchange="calcPHQ()"> Nearly every day (3)</label>
          </div>
        </div>
        <div id="phq-result" style="display:none;padding:10px 14px;border-radius:8px;font-size:13px;font-weight:600;margin-top:6px"></div>
      </div>

      <div class="card">
        <div class="card-title">Review of Systems (ROS)</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:16px;">

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Constitutional</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Fever</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Fatigue</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Weight loss</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Cardiovascular</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Chest pain</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Palpitations</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Edema</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Respiratory</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Cough</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Shortness of breath</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Wheezing</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Gastrointestinal</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Nausea</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Vomiting</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Abdominal pain</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Neurological</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Headache</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Dizziness</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Numbness</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Musculoskeletal</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Joint pain</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Swelling</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Back pain</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Dermatological</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Rash</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Itching</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Lesions</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Psychiatric</div>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Depression</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Anxiety</span></label>
            <label class="ros-label"><input type="checkbox" class="ros"><span>Sleep issues</span></label>
          </div>

        </div>
      </div>
      <div class="card">
        <div class="card-title">Physical Exam (PE)</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:16px;">

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">General</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Well-appearing</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>In distress</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">HEENT</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>PERRL</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Throat clear</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Cardiovascular</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>RRR no murmur</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Murmur present</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Lungs</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>CTA bilaterally</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Wheezing</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Abdomen</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Soft non-tender</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Tenderness</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Extremities</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>No edema</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Edema 1+</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Skin</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Warm/dry</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Rash noted</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Neurological</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>A&amp;Ox3</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Deficit noted</span></label>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">Eyes / Vision</div>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Vision screened</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>20/20 or corrected to 20/20</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Deficit noted</span></label>
            <label class="pe-label"><input type="checkbox" class="pe"><span>Referral placed</span></label>
          </div>

        </div>
      </div>
      <div class="card">
        <div class="card-title">Patient Screenings</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:16px">Document preventive screenings discussed or performed during this visit. Check all that were addressed.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">

          <div>
            <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#047857;background:#d4f8ed;border-radius:6px;padding:6px 10px;margin-bottom:12px">‚ôÇ Male-Specific Screenings</div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
                <input type="checkbox" id="screen-psa" style="margin-top:2px;flex-shrink:0">
                <div><div style="font-weight:600">Prostate Screening (PSA)</div><div style="font-size:12px;color:var(--text3)">Recommended for males 50+ (45+ if high risk). Discuss benefits and risks with patient.</div></div>
              </label>
              <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
                <input type="checkbox" id="screen-testicular" style="margin-top:2px;flex-shrink:0">
                <div><div style="font-weight:600">Testicular Exam Education</div><div style="font-size:12px;color:var(--text3)">Monthly self-exam technique reviewed with patient. Abnormalities to report discussed.</div></div>
              </label>
              <div style="margin-top:4px">
                <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Notes / Result</label>
                <input id="screen-male-notes" placeholder="e.g. PSA ordered, results pending..." style="font-size:12px">
              </div>
            </div>
          </div>

          <div>
            <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#be185d;background:#fce7f3;border-radius:6px;padding:6px 10px;margin-bottom:12px">‚ôÄ Female-Specific Screenings</div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
                <input type="checkbox" id="screen-mammo" style="margin-top:2px;flex-shrink:0">
                <div><div style="font-weight:600">Mammogram Referral</div><div style="font-size:12px;color:var(--text3)">Recommended annually ages 40‚Äì74. Referral placed or previously completed.</div></div>
              </label>
              <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
                <input type="checkbox" id="screen-pap" style="margin-top:2px;flex-shrink:0">
                <div><div style="font-weight:600">Pap Smear</div><div style="font-size:12px;color:var(--text3)">Every 3 years ages 21‚Äì65 (or every 5 years with HPV co-test ages 30‚Äì65).</div></div>
              </label>
              <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
                <input type="checkbox" id="screen-bse" style="margin-top:2px;flex-shrink:0">
                <div><div style="font-weight:600">Breast Self-Exam Education</div><div style="font-size:12px;color:var(--text3)">Monthly self-exam technique reviewed. Patient verbalized understanding.</div></div>
              </label>
              <div style="margin-top:4px">
                <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Notes / Result</label>
                <input id="screen-female-notes" placeholder="e.g. Pap completed, mammogram referral sent..." style="font-size:12px">
              </div>
            </div>
          </div>

        </div>
        <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px">General Screenings</div>
          <div style="display:flex;flex-wrap:wrap;gap:12px;">
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="screen-vision-enc"> Vision Screening</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="screen-hearing"> Hearing Screen</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="screen-bmi-enc"> BMI / Weight Counseling</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="screen-bp"> Blood Pressure Screen</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="screen-diabetes"> Diabetes Risk Screen</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="screen-fall"> Fall Risk Assessment</label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Assessment & Plan</div>
        <textarea id="enc-ap" rows="5" placeholder="Assessment and plan..."></textarea>
      </div>
      <div class="card">
        <div class="card-title">üîè Consent to Treatment ‚Äî Informed Consent</div>
        <div style="background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:#1e40af">
          This section documents that informed consent was obtained prior to the procedure or treatment listed below.
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:2"><label>Patient Name</label><input id="consent-name" placeholder="Full legal name"></div>
          <div class="form-group"><label>Date of Birth</label><input id="consent-dob" type="date"></div>
          <div class="form-group"><label>Date of Consent</label><input id="consent-date" type="date"></div>
        </div>
        <div class="form-group" style="margin-bottom:14px"><label>Procedure / Treatment Consented</label><input id="consent-procedure" placeholder="e.g. Venipuncture, Urinalysis, Physical Examination"></div>
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:10px">Provider Attestation</div>
        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
          <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="consent-risks" style="margin-top:2px;flex-shrink:0">
            <span>Risks and benefits of the procedure/treatment were explained to the patient in terms they could understand.</span>
          </label>
          <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="consent-questions" style="margin-top:2px;flex-shrink:0">
            <span>Patient questions were answered to their satisfaction.</span>
          </label>
          <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="consent-understanding" style="margin-top:2px;flex-shrink:0">
            <span>Patient demonstrates understanding and voluntarily agrees to proceed.</span>
          </label>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:16px">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:12px">Patient Signature</div>
          <canvas id="consent-canvas" width="600" height="100" style="border:1px solid var(--border);border-radius:8px;background:#fff;cursor:crosshair;display:block;touch-action:none"></canvas>
          <div style="display:flex;gap:10px;margin-top:8px">
            <button class="btn btn-sm btn-secondary no-print" onclick="clearSignature()">‚úï Clear Signature</button>
            <span style="font-size:12px;color:var(--text3);align-self:center">Sign above using mouse or touchscreen</span>
          </div>
        </div>
      </div>
      <button class="btn btn-primary no-print" onclick="saveEncounter()">üíæ Save Encounter</button>
      </div><!-- end enc-standard -->

      <!-- PEDIATRIC ENCOUNTER -->
      <div id="enc-pediatric" style="display:none">

        <div class="card" style="border-left:4px solid #0e7490;background:#f0f9ff">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-size:28px">ü©∫</div>
            <div>
              <div style="font-weight:700;font-size:15px;color:#0e7490">Pediatric Encounter Form</div>
              <div style="font-size:12px;color:var(--text2)" id="ped-patient-label">Well-child and pediatric acute visit documentation</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Chief Complaint & Reason for Visit</div>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label>Chief Complaint</label><input id="ped-cc" placeholder="e.g. Well-child visit, fever, ear pain..."></div>
            <div class="form-group"><label>Visit Type</label>
              <select id="ped-visit-type">
                <option>Well-Child Visit</option>
                <option>Acute Illness</option>
                <option>Follow-Up</option>
                <option>Sports Physical</option>
                <option>Immunization Only</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>History of Present Illness / Parent Concern</label>
            <textarea id="ped-hpi" rows="3" placeholder="Describe the presenting concern. Include onset, duration, associated symptoms, and parent/guardian observations..."></textarea>
          </div>
          <div class="form-group"><label>Parent / Guardian Concerns</label>
            <input id="ped-parent-concern" placeholder="Additional concerns raised by parent or guardian today...">
          </div>
        </div>

        <div class="card">
          <div class="card-title">Growth & Development</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px">
            <div>
              <label style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px">Height Percentile</label>
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <input id="ped-ht-pct" type="number" min="1" max="99" placeholder="e.g. 65" style="width:80px">
                <span style="font-size:13px;color:var(--text2)">%ile</span>
              </div>
            </div>
            <div>
              <label style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px">Weight Percentile</label>
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <input id="ped-wt-pct" type="number" min="1" max="99" placeholder="e.g. 45" style="width:80px">
                <span style="font-size:13px;color:var(--text2)">%ile</span>
              </div>
            </div>
            <div>
              <label style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px">BMI Percentile</label>
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <input id="ped-bmi-pct" type="number" min="1" max="99" placeholder="e.g. 55" style="width:80px">
                <span style="font-size:13px;color:var(--text2)">%ile</span>
                <span id="ped-bmi-cat" style="font-size:11px;font-weight:700;padding:2px 8px;border-radius:12px"></span>
              </div>
            </div>
          </div>
          <div style="margin-bottom:14px">
            <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Growth Trend</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div style="display:flex;gap:24px;">
                <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;white-space:nowrap"><input type="radio" name="ped-growth" value="Following curve"><span>Following growth curve</span></label>
                <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;white-space:nowrap"><input type="radio" name="ped-growth" value="Crossing up"><span>Crossing up (gaining percentile)</span></label>
              </div>
              <div style="display:flex;gap:24px;">
                <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;white-space:nowrap"><input type="radio" name="ped-growth" value="Crossing down"><span>Crossing down (losing percentile)</span></label>
                <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;white-space:nowrap"><input type="radio" name="ped-growth" value="Insufficient data"><span>Insufficient data</span></label>
              </div>
            </div>
          </div>
          <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Developmental Milestones</div>
          <div id="ped-milestones-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
          <div style="margin-top:12px">
            <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Developmental Notes</label>
            <textarea id="ped-dev-notes" rows="2" placeholder="Additional developmental observations or concerns..."></textarea>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Immunization Status</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:14px">Review immunization history. Check all vaccines that are current/up to date for this patient's age.</div>
          <div id="ped-immunization-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:16px"></div>
          <div style="padding-top:14px;border-top:1px solid var(--border)">
            <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Vaccines Administered Today</div>
            <div class="form-row">
              <div class="form-group" style="flex:2"><label>Vaccine Name</label><input id="ped-vax-name" placeholder="e.g. MMR, DTaP, Varicella"></div>
              <div class="form-group"><label>Lot Number</label><input id="ped-vax-lot" placeholder="e.g. AB1234"></div>
              <div class="form-group"><label>Site</label><select id="ped-vax-site"><option>Left deltoid</option><option>Right deltoid</option><option>Left thigh</option><option>Right thigh</option><option>Oral</option><option>Intranasal</option></select></div>
              <div class="form-group" style="justify-content:flex-end;align-items:flex-end"><button class="btn btn-sm btn-primary" onclick="addPedVax()">+ Add</button></div>
            </div>
            <div id="ped-vax-list"></div>
          </div>
          <div style="margin-top:12px">
            <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Immunization Notes</label>
            <input id="ped-imm-notes" placeholder="e.g. Parent declined Hep B today, VIS provided, next vaccines due at 18mo visit...">
          </div>
        </div>

        <div class="card">
          <div class="card-title">Nutritional Assessment</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div>
              <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Feeding / Diet</div>
              <div id="ped-feeding-section"></div>
              <div style="margin-top:10px">
                <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Daily Meals / Snacks</label>
                <input id="ped-meals" placeholder="e.g. 3 meals + 2 snacks daily">
              </div>
              <div style="margin-top:10px">
                <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Fluid Intake</label>
                <input id="ped-fluids" placeholder="e.g. Water, juice, milk oz/day">
              </div>
            </div>
            <div>
              <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Lifestyle & Safety</div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-screen-time"> Screen time discussed (&lt;1hr/day &lt;5yr, &lt;2hr/day 5+yr)</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-activity"> Physical activity discussed (60 min/day recommended)</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-sleep"> Sleep habits reviewed (age-appropriate hours)</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-carseat"> Car seat / safety restraint counseling</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-helmet"> Helmet / sports safety counseling</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-firearm"> Firearm safety in home discussed</label>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-dental"> Dental hygiene reviewed</label>
              </div>
            </div>
          </div>
          <div style="margin-top:14px">
            <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Nutritional Notes</label>
            <textarea id="ped-nutrition-notes" rows="2" placeholder="Dietary concerns, supplements, feeding difficulties, referrals..."></textarea>
          </div>
        </div>

        <div class="card">
          <div class="card-title">School & Behavioral</div>
          <div class="form-row">
            <div class="form-group"><label>Grade Level</label><input id="ped-grade" placeholder="e.g. Kindergarten, 4th grade"></div>
            <div class="form-group"><label>Academic Performance</label>
              <select id="ped-academic">
                <option value="">‚Äî Select ‚Äî</option>
                <option>Excellent</option><option>Above average</option><option>Average</option>
                <option>Below average</option><option>Struggling</option><option>Not yet school age</option>
              </select>
            </div>
            <div class="form-group"><label>IEP / 504 Plan</label>
              <select id="ped-iep">
                <option value="">‚Äî Select ‚Äî</option>
                <option>None</option><option>IEP in place</option><option>504 Plan</option><option>Being evaluated</option>
              </select>
            </div>
          </div>
          <div style="margin-top:8px">
            <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Behavioral Concerns</div>
            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px">
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="beh-attention"> Attention/ADHD</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="beh-anxiety"> Anxiety</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="beh-mood"> Mood changes</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="beh-social"> Social difficulties</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="beh-sleep"> Sleep problems</label>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="beh-none"> No concerns</label>
            </div>
            <textarea id="ped-beh-notes" rows="2" placeholder="Additional behavioral or school-related notes..."></textarea>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Assessment & Plan</div>
          <textarea id="ped-ap" rows="5" placeholder="Assessment and plan for this pediatric encounter..."></textarea>
        </div>
        <div style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Next Well-Child Visit Due</label>
          <input id="ped-next-visit" type="date" style="width:200px">
        </div>
        <button class="btn btn-primary no-print" onclick="savePedEncounter()">üíæ Save Pediatric Encounter</button>
      </div><!-- end enc-pediatric -->

    </div>

    <!-- REQUISITIONS -->
    <div class="section" id="section-requisitions">
      <div class="section-title">‚úÖ Requisitions</div>
      <div class="card no-print">
        <div class="card-title">Add Requisition</div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="req-cat">
              <option>Medication entry</option><option>Orders</option><option>Problems</option>
              <option>Allergies</option><option>Teaching</option><option>Labs</option>
              <option>Imaging</option><option>Vitals</option><option>Appointments</option>
            </select>
          </div>
          <div class="form-group" style="flex:3"><label>Description</label><input id="req-desc" placeholder="Describe the task..."></div>
        </div>
        <button class="btn btn-primary" onclick="addRequisition()">+ Add Task</button>
      </div>
      <div class="card">
        <div class="card-title">Task List</div>
        <div id="req-progress-wrap" class="mb-8">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span class="text-sm text-muted">Completion</span>
            <span class="text-sm font-mono" id="req-pct">0%</span>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="req-progress-fill" style="width:0%"></div></div>
        </div>
        <div id="req-list"></div>
      </div>
    </div>

    <!-- VISIT CHARGES -->
    <div class="section" id="section-visit-charges">
      <div class="section-title">üí∞ Visit Charges</div>
      <div class="card no-print">
        <div class="card-title">Add Charge ‚Äî Select from List</div>
        <div class="form-row">
          <div class="form-group" style="flex:2">
            <label>CPT Code / Service</label>
            <select id="charge-cpt" onchange="fillCharge()">
              <option value="">-- Select CPT Code --</option>
              <option value="99213|Office Visit - Established, Level 3|150">99213 - Office Visit Established Lv3 - $150</option>
              <option value="99214|Office Visit - Established, Level 4|220">99214 - Office Visit Established Lv4 - $220</option>
              <option value="99215|Office Visit - Established, Level 5|310">99215 - Office Visit Established Lv5 - $310</option>
              <option value="99202|Office Visit - New Patient, Level 2|175">99202 - Office Visit New Patient Lv2 - $175</option>
              <option value="99203|Office Visit - New Patient, Level 3|230">99203 - Office Visit New Patient Lv3 - $230</option>
              <option value="99204|Office Visit - New Patient, Level 4|290">99204 - Office Visit New Patient Lv4 - $290</option>
              <option value="99205|Office Visit - New Patient, Level 5|375">99205 - Office Visit New Patient Lv5 - $375</option>
              <option value="85025|CBC with Differential|85">85025 - CBC with Differential - $85</option>
              <option value="80053|Comprehensive Metabolic Panel|110">80053 - Comprehensive Metabolic Panel - $110</option>
              <option value="80061|Lipid Panel|95">80061 - Lipid Panel - $95</option>
              <option value="82947|Glucose, Blood|45">82947 - Glucose, Blood - $45</option>
              <option value="81001|Urinalysis|55">81001 - Urinalysis - $55</option>
              <option value="84703|hCG Pregnancy Test|65">84703 - hCG Pregnancy Test - $65</option>
              <option value="87880|Strep A Rapid Test|70">87880 - Strep A Rapid Test - $70</option>
              <option value="71046|Chest X-Ray, 2 views|195">71046 - Chest X-Ray, 2 views - $195</option>
              <option value="73030|Shoulder X-Ray, 2 views|165">73030 - Shoulder X-Ray, 2 views - $165</option>
              <option value="93000|EKG with interpretation|120">93000 - EKG with interpretation - $120</option>
              <option value="90471|Immunization Administration|25">90471 - Immunization Administration - $25</option>
              <option value="90658|Influenza Vaccine|35">90658 - Influenza Vaccine - $35</option>
              <option value="96372|Therapeutic Injection|55">96372 - Therapeutic Injection - $55</option>
              <option value="99213-25|Office Visit with Procedure|175">99213-25 - Office Visit with Procedure - $175</option>
              <option value="99000|Handling/Conveyance of Specimen|15">99000 - Handling/Conveyance Specimen - $15</option>
            </select>
          </div>
          <div class="form-group"><label>Amount ($)</label><input id="charge-amount" type="number" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Description</label><input id="charge-desc" placeholder="Service description"></div>
        </div>
        <button class="btn btn-primary" onclick="addCharge()">+ Add Charge</button>
      </div>

      <div class="card no-print">
        <div class="card-title">Add Charge ‚Äî Manual Entry</div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:12px">Use this if the code is not in the list above. Accepts CPT or ICD-10 codes.</div>
        <div class="form-row">
          <div class="form-group">
            <label>Code Type</label>
            <select id="manual-code-type">
              <option value="CPT">CPT</option>
              <option value="ICD-10">ICD-10</option>
              <option value="HCPCS">HCPCS</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div class="form-group"><label>Code</label><input id="manual-code" placeholder="e.g. 93010 or Z00.00"></div>
          <div class="form-group" style="flex:2"><label>Description</label><input id="manual-desc" placeholder="Describe the service or diagnosis"></div>
          <div class="form-group"><label>Amount ($)</label><input id="manual-amount" type="number" step="0.01" placeholder="0.00"></div>
        </div>
        <button class="btn btn-primary" onclick="addManualCharge()">+ Add Manual Charge</button>
      </div>
      <div class="card">
        <div class="card-title">Charges</div>
        <div id="charges-list"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:12px">
          <div class="font-mono" style="font-size:16px;font-weight:700">Total: $<span id="charges-total">0.00</span></div>
        </div>
      </div>
    </div>

    <!-- CHECKOUT -->
    <div class="section" id="section-checkout">
      <div class="section-title">üèÅ Checkout</div>
      <div id="checkout-content">
        <p class="text-muted">Select a patient to view checkout.</p>
      </div>
    </div>

  </main>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- ADD PATIENT MODAL -->
<div id="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:28px;width:520px;max-width:95vw">
    <h3 style="margin-bottom:16px;font-size:18px">Add New Patient</h3>
    <div class="form-row">
      <div class="form-group"><label>First Name</label><input id="np-fname" placeholder="First name"></div>
      <div class="form-group"><label>Last Name</label><input id="np-lname" placeholder="Last name"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date of Birth</label><input id="np-dob" type="date"></div>
      <div class="form-group"><label>Gender</label><select id="np-gender"><option>Male</option><option>Female</option><option>Non-binary</option><option>Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Phone</label><input id="np-phone" placeholder="(555) 000-0000"></div>
      <div class="form-group"><label>Insurance</label><input id="np-ins" placeholder="Insurance provider"></div>
    </div>
    <div class="form-group" style="margin-bottom:16px"><label>Address</label><input id="np-addr" placeholder="Street, City, State, ZIP"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveNewPatient()">Add Patient</button>
    </div>
  </div>
</div>

<script>
// ===================== DATA =====================
const today = new Date().toISOString().split('T')[0];
const fmtDate = d => { const [y,m,day] = d.split('-'); return new Date(y, m-1, day).toLocaleDateString(); };
const ts = () => new Date().toLocaleString();

let patients = [
  {
    id: 'MRN00001', fname: 'Ethan', lname: 'Morales', dob: '2020-06-12', gender: 'Male',
    guardian: 'Maria Morales',
    phone: '(555) 210-3344', address: '123 Maple St, Springfield, IL',
    insurance: 'Medicaid ‚Äì State Children\'s Health Program', insId: 'SCHP458210', copay: 0, deductible: 0, deductibleMet: 0,
    checkedIn: false,
    allergies: [{allergen:'Amoxicillin',reaction:'Hives',severity:'Moderate'}],
    meds: [{name:'Albuterol', dose:'90mcg', freq:'PRN', route:'Inhaled'}],
    problems: [{code:'J45.20', desc:'Mild intermittent asthma', status:'Active'}, {code:'Z00.00', desc:'Well child visit', status:'Active'}],
    vitalsHistory: [{date:'2024-11-10', temp:98.8, bps:90, bpd:58, hr:100, rr:22, wt:42, o2:99}],
    visitHistory: [{date:'2024-11-10', type:'Sick Visit', provider:'Dr. Kim', reason:'Cough/Wheeze'},{date:'2024-06-15', type:'Well Child', provider:'Dr. Kim', reason:'Annual checkup'}],
    notes: [{date:'2024-11-10', type:'SOAP Note', provider:'Dr. Kim', content:'5yo male with asthma exacerbation. Mild wheeze bilaterally. Albuterol given. Improved. Home with rescue inhaler.'}],
    orders: [], labProcs: [], appointments: [], encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00002', fname: 'Lily', lname: 'Chen', dob: '2015-03-18', gender: 'Female',
    guardian: 'David Chen',
    phone: '(555) 334-7821', address: '88 Oak Ave, Springfield, IL',
    insurance: 'Blue Cross Blue Shield PPO', insId: 'BC778234', copay: 20, deductible: 500, deductibleMet: 200,
    checkedIn: false,
    allergies: [{allergen:'Shellfish',reaction:'Anaphylaxis',severity:'Severe'},{allergen:'Latex',reaction:'Rash',severity:'Mild'}],
    meds: [{name:'EpiPen', dose:'0.15mg', freq:'PRN anaphylaxis', route:'IM'},{name:'Zyrtec', dose:'5mg', freq:'Once daily', route:'Oral'}],
    problems: [{code:'T78.1XXA', desc:'Anaphylaxis due to food allergy', status:'Active'},{code:'J30.1', desc:'Allergic rhinitis due to pollen', status:'Chronic'}],
    vitalsHistory: [{date:'2024-12-05', temp:98.2, bps:95, bpd:60, hr:88, rr:18, wt:62, o2:98}],
    visitHistory: [{date:'2024-12-05', type:'Follow-up', provider:'Dr. Patel', reason:'Allergy management'},{date:'2024-08-20', type:'Urgent', provider:'Dr. Patel', reason:'Allergic reaction'}],
    notes: [{date:'2024-12-05', type:'Progress Note', provider:'Dr. Patel', content:'9yo female for allergy f/u. No recent reactions. Carrying EpiPen. Rhinitis improving with Zyrtec.'}],
    orders: [], labProcs: [], appointments: [], encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00003', fname: 'Jamal', lname: 'Robinson', dob: '2009-08-22', gender: 'Male',
    phone: '(555) 901-4421', address: '455 Pine Dr, Springfield, IL',
    insurance: 'United Healthcare', insId: 'UH556789', copay: 30, deductible: 750, deductibleMet: 500,
    checkedIn: false,
    allergies: [{allergen:'NKDA',reaction:'None known',severity:'N/A'}],
    meds: [{name:'Adderall XR', dose:'15mg', freq:'Once daily', route:'Oral'},{name:'Melatonin', dose:'3mg', freq:'Nightly', route:'Oral'}],
    problems: [{code:'F90.0', desc:'ADHD, predominantly inattentive', status:'Active'},{code:'G47.00', desc:'Insomnia, unspecified', status:'Active'}],
    vitalsHistory: [{date:'2025-01-08', temp:98.6, bps:112, bpd:70, hr:78, rr:16, wt:130, o2:99}],
    visitHistory: [{date:'2025-01-08', type:'Follow-up', provider:'Dr. Cohen', reason:'ADHD medication management'},{date:'2024-09-15', type:'New Patient', provider:'Dr. Cohen', reason:'ADHD evaluation'}],
    notes: [{date:'2025-01-08', type:'Progress Note', provider:'Dr. Cohen', content:'15yo male for ADHD f/u. Doing well on Adderall XR 15mg. GPA improved to 3.1. Sleep slightly better with melatonin.'}],
    orders: [], labProcs: [], appointments: [], encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00004', fname: 'Sofia', lname: 'Martinez', dob: '2002-11-05', gender: 'Female',
    phone: '(555) 663-9921', address: '19 College Way, Springfield, IL',
    insurance: 'Aetna Student Health Plan', insId: 'AE998234', copay: 10, deductible: 250, deductibleMet: 0,
    checkedIn: false,
    allergies: [{allergen:'Sulfa drugs',reaction:'Rash',severity:'Mild'}],
    meds: [{name:'Ortho Tri-Cyclen', dose:'1 tab', freq:'Once daily', route:'Oral'},{name:'Vitamin D3', dose:'2000 IU', freq:'Once daily', route:'Oral'}],
    problems: [{code:'N94.6', desc:'Dysmenorrhea, unspecified', status:'Active'},{code:'E55.9', desc:'Vitamin D deficiency', status:'Resolved'}],
    vitalsHistory: [{date:'2025-01-15', temp:98.4, bps:110, bpd:68, hr:72, rr:16, wt:128, o2:100}],
    visitHistory: [{date:'2025-01-15', type:'Gynecology', provider:'Dr. Nguyen', reason:'Contraception/dysmenorrhea'},{date:'2024-10-01', type:'Sick Visit', provider:'Dr. Nguyen', reason:'Fatigue, Vitamin D check'}],
    notes: [{date:'2025-01-15', type:'SOAP Note', provider:'Dr. Nguyen', content:'22yo female for annual and OCP refill. No concerns. Labs ordered: TSH, CBC. Dysmenorrhea controlled on OCP.'}],
    orders: [], labProcs: [], appointments: [], encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00005', fname: 'Sarah', lname: 'Thompson', dob: '1996-02-14', gender: 'Female',
    phone: '(555) 443-2210', address: '700 Willow Ln, Springfield, IL',
    insurance: 'Blue Cross Blue Shield', insId: 'BC991122', copay: 25, deductible: 1000, deductibleMet: 400,
    checkedIn: false,
    allergies: [{allergen:'Codeine',reaction:'Nausea/Vomiting',severity:'Moderate'},{allergen:'Ibuprofen',reaction:'GI upset',severity:'Mild'}],
    meds: [{name:'Synthroid', dose:'75mcg', freq:'Once daily', route:'Oral'},{name:'Lexapro', dose:'10mg', freq:'Once daily', route:'Oral'}],
    problems: [{code:'E03.9', desc:'Hypothyroidism, unspecified', status:'Chronic'},{code:'F32.1', desc:'Major depressive disorder, moderate', status:'Active'},{code:'Z13.88', desc:'Encounter for screening - depression', status:'Active'}],
    vitalsHistory: [{date:'2025-02-01', temp:97.9, bps:118, bpd:75, hr:65, rr:14, wt:142, o2:99},{date:'2024-11-20', temp:98.1, bps:122, bpd:78, hr:68, rr:15, wt:140, o2:98}],
    visitHistory: [{date:'2025-02-01', type:'Follow-up', provider:'Dr. Walsh', reason:'Thyroid & MDD management'},{date:'2024-11-20', type:'Follow-up', provider:'Dr. Walsh', reason:'Medication review'},{date:'2024-08-10', type:'Annual Physical', provider:'Dr. Walsh', reason:'Annual exam'}],
    notes: [{date:'2025-02-01', type:'SOAP Note', provider:'Dr. Walsh', content:'29yo female for f/u hypothyroidism and MDD. TSH was 2.1 last check - therapeutic. Mood improved on Lexapro 10mg, no side effects.'},{date:'2024-08-10', type:'Progress Note', provider:'Dr. Walsh', content:'Annual exam. All screening up to date. Labs: TSH, CMP, CBC ordered. Mammogram in 1 yr.'}],
    orders: [{id:'ord1', type:'Lab', detail:'TSH, Free T4', priority:'Routine', status:'Completed', result:'TSH: 2.1 (0.4-4.0) | Free T4: 1.2 (0.8-1.8)'},{id:'ord2', type:'Lab', detail:'CBC with Diff', priority:'Routine', status:'In Progress', result:''}],
    labProcs: [], appointments: [{date:'2025-04-01', time:'10:00', type:'Follow-up', provider:'Dr. Walsh', reason:'Thyroid recheck'}], 
    encounter: {cc:'',hpi:'',ap:''},
    requisitions: [{cat:'Labs', desc:'Order TSH, Free T4', done:true},{cat:'Labs', desc:'Order CBC', done:false}], charges: []
  },
  {
    id: 'MRN00006', fname: 'Michael', lname: 'Turner', dob: '1990-07-09', gender: 'Male',
    phone: '(555) 338-1009', address: '55 Industrial Rd, Springfield, IL',
    insurance: "Workers' Compensation", insId: 'WC332211', copay: 0, deductible: 0, deductibleMet: 0,
    checkedIn: false,
    allergies: [{allergen:'Penicillin',reaction:'Anaphylaxis',severity:'Severe'}],
    meds: [{name:'Naproxen', dose:'500mg', freq:'Twice daily with food', route:'Oral'},{name:'Cyclobenzaprine', dose:'10mg', freq:'At bedtime', route:'Oral'},{name:'Omeprazole', dose:'20mg', freq:'Once daily', route:'Oral'}],
    problems: [{code:'M54.5', desc:'Low back pain', status:'Active'},{code:'S39.012A', desc:'Strain of muscle of lower back', status:'Active'},{code:'Z57.1', desc:'Occupational exposure to radiation', status:'Active'}],
    vitalsHistory: [{date:'2025-01-20', temp:98.6, bps:130, bpd:84, hr:78, rr:16, wt:195, o2:98}],
    visitHistory: [{date:'2025-01-20', type:'Workers Comp', provider:'Dr. Evans', reason:'Back injury - construction site'},{date:'2024-12-15', type:'Workers Comp', provider:'Dr. Evans', reason:'Follow-up back pain'}],
    notes: [{date:'2025-01-20', type:'SOAP Note', provider:'Dr. Evans', content:'34yo male, construction worker, lower back injury 12/10/24 lifting 80 lb equipment. Pain 7/10, radiating left leg. MRI ordered. Light duty work restrictions.'}],
    orders: [{id:'ord3', type:'Imaging', detail:'MRI Lumbar Spine without contrast', priority:'Urgent', status:'Pending', result:''}],
    labProcs: [], appointments: [{date:'2025-02-20', time:'14:00', type:'Follow-up', provider:'Dr. Evans', reason:'MRI results review'}], 
    encounter: {cc:'',hpi:'',ap:''},
    requisitions: [], charges: []
  },
  {
    id: 'MRN00007', fname: 'Angela', lname: 'Brooks', dob: '1979-01-27', gender: 'Female',
    phone: '(555) 889-7712', address: '900 Meadow Ct, Springfield, IL',
    insurance: 'Medicare Advantage', insId: 'MA443322', copay: 20, deductible: 240, deductibleMet: 240,
    checkedIn: false,
    allergies: [{allergen:'Aspirin',reaction:'Asthma exacerbation',severity:'Severe'},{allergen:'Sulfa',reaction:'Rash',severity:'Mild'}],
    meds: [{name:'Metformin', dose:'1000mg', freq:'Twice daily', route:'Oral'},{name:'Lisinopril', dose:'10mg', freq:'Once daily', route:'Oral'},{name:'Atorvastatin', dose:'40mg', freq:'Nightly', route:'Oral'},{name:'Albuterol', dose:'90mcg', freq:'PRN', route:'Inhaled'}],
    problems: [{code:'E11.9', desc:'Type 2 diabetes mellitus without complications', status:'Chronic'},{code:'I10', desc:'Essential (primary) hypertension', status:'Chronic'},{code:'E78.5', desc:'Hyperlipidemia, unspecified', status:'Chronic'},{code:'J45.30', desc:'Moderate persistent asthma', status:'Chronic'}],
    vitalsHistory: [{date:'2025-01-25', temp:98.3, bps:142, bpd:88, hr:74, rr:18, wt:182, o2:97},{date:'2024-10-15', temp:98.5, bps:148, bpd:92, hr:76, rr:18, wt:185, o2:97}],
    visitHistory: [{date:'2025-01-25', type:'Follow-up', provider:'Dr. Okafor', reason:'DM, HTN management'},{date:'2024-10-15', type:'Follow-up', provider:'Dr. Okafor', reason:'Chronic disease management'},{date:'2024-07-10', type:'Annual Physical', provider:'Dr. Okafor', reason:'Annual Medicare wellness visit'}],
    notes: [{date:'2025-01-25', type:'SOAP Note', provider:'Dr. Okafor', content:'45yo female with T2DM, HTN, HLD, asthma. A1c last 7.2% - fair control. BP today 142/88 - elevated. Increase Lisinopril to 20mg. Fasting lipid panel ordered.'}],
    orders: [{id:'ord4', type:'Lab', detail:'HbA1c, Lipid Panel, CMP', priority:'Routine', status:'Pending', result:''}],
    labProcs: [], appointments: [], encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00008', fname: 'Robert', lname: 'King', dob: '1966-04-11', gender: 'Male',
    phone: '(555) 120-8899', address: '61 Ridge Rd, Springfield, IL',
    insurance: 'United Healthcare', insId: 'UH334455', copay: 40, deductible: 2000, deductibleMet: 1200,
    checkedIn: false,
    allergies: [{allergen:'Metoprolol',reaction:'Bradycardia',severity:'Severe'},{allergen:'Contrast dye',reaction:'Hives',severity:'Moderate'}],
    meds: [{name:'Amlodipine', dose:'5mg', freq:'Once daily', route:'Oral'},{name:'Rosuvastatin', dose:'20mg', freq:'Nightly', route:'Oral'},{name:'Aspirin', dose:'81mg', freq:'Once daily', route:'Oral'},{name:'Nitroglycerin', dose:'0.4mg SL', freq:'PRN chest pain', route:'Sublingual'}],
    problems: [{code:'I25.10', desc:'Coronary artery disease', status:'Chronic'},{code:'I10', desc:'Essential hypertension', status:'Chronic'},{code:'Z95.5', desc:'Presence of coronary angioplasty implant', status:'Chronic'},{code:'Z82.49', desc:'Family history of ischemic heart disease', status:'Active'}],
    vitalsHistory: [{date:'2025-02-05', temp:98.0, bps:136, bpd:82, hr:58, rr:15, wt:210, o2:97}],
    visitHistory: [{date:'2025-02-05', type:'Cardiology Follow-up', provider:'Dr. Sharma', reason:'CAD management post-stent'},{date:'2024-11-01', type:'Follow-up', provider:'Dr. Sharma', reason:'Chest pain evaluation'},{date:'2024-08-15', type:'Procedure', provider:'Dr. Sharma', reason:'Cardiac catheterization'}],
    notes: [{date:'2025-02-05', type:'Consultation Note', provider:'Dr. Sharma', content:'58yo male, 6 months post PCI LAD. No angina. Echo EF 55%. Continue dual antiplatelet therapy. Stress test in 12 months.'}],
    orders: [{id:'ord5', type:'Imaging', detail:'Echocardiogram', priority:'Routine', status:'Completed', result:'EF 55%, no wall motion abnormalities, mild LV hypertrophy'}],
    labProcs: [], appointments: [{date:'2025-08-05', time:'09:00', type:'Follow-up', provider:'Dr. Sharma', reason:'Annual cardiology review with stress test'}],
    encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00009', fname: 'Carol', lname: 'White', dob: '1957-09-30', gender: 'Female',
    phone: '(555) 774-1100', address: '82 Lake View Dr, Springfield, IL',
    insurance: 'Medicare', insId: 'MC556677', copay: 20, deductible: 240, deductibleMet: 120,
    checkedIn: false,
    allergies: [{allergen:'Tetracycline',reaction:'Photosensitivity',severity:'Mild'}],
    meds: [{name:'Alendronate', dose:'70mg', freq:'Weekly', route:'Oral'},{name:'Vitamin D3', dose:'2000 IU', freq:'Once daily', route:'Oral'},{name:'Calcium Carbonate', dose:'1200mg', freq:'Once daily', route:'Oral'},{name:'Metoprolol succinate', dose:'25mg', freq:'Once daily', route:'Oral'}],
    problems: [{code:'M81.0', desc:'Osteoporosis without pathological fracture', status:'Chronic'},{code:'I25.10', desc:'Coronary artery disease', status:'Chronic'},{code:'N40.0', desc:'Benign prostatic hyperplasia without LUTS', status:'Active'},{code:'E11.9', desc:'Type 2 diabetes mellitus', status:'Chronic'}],
    vitalsHistory: [{date:'2025-01-30', temp:98.1, bps:128, bpd:76, hr:62, rr:14, wt:156, o2:99}],
    visitHistory: [{date:'2025-01-30', type:'Annual Physical', provider:'Dr. Pham', reason:'Medicare Annual Wellness Visit'},{date:'2024-09-12', type:'Follow-up', provider:'Dr. Pham', reason:'Osteoporosis - DEXA review'}],
    notes: [{date:'2025-01-30', type:'SOAP Note', provider:'Dr. Pham', content:'67yo female for AWV. DEXA: T-score -2.5 lumbar (osteoporosis). Continue Alendronate. Fall risk assessment done - low risk. Flu vaccine given.'}],
    orders: [], labProcs: [], appointments: [], encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00010', fname: 'Harold', lname: 'Simmons', dob: '1950-12-02', gender: 'Male',
    phone: '(555) 210-9988', address: '14 Evergreen Ln, Springfield, IL',
    insurance: 'Medicare', insId: 'MC889900', copay: 20, deductible: 240, deductibleMet: 240,
    checkedIn: false,
    allergies: [{allergen:'Morphine',reaction:'Respiratory depression',severity:'Severe'},{allergen:'Penicillin',reaction:'Rash',severity:'Moderate'}],
    meds: [{name:'Warfarin', dose:'5mg', freq:'Once daily', route:'Oral'},{name:'Furosemide', dose:'40mg', freq:'Once daily', route:'Oral'},{name:'Carvedilol', dose:'12.5mg', freq:'Twice daily', route:'Oral'},{name:'Spironolactone', dose:'25mg', freq:'Once daily', route:'Oral'},{name:'Lisinopril', dose:'20mg', freq:'Once daily', route:'Oral'}],
    problems: [{code:'I50.32', desc:'Chronic systolic HF, moderate', status:'Chronic'},{code:'I48.19', desc:'Persistent atrial fibrillation', status:'Chronic'},{code:'I25.10', desc:'CAD', status:'Chronic'},{code:'N18.3', desc:'CKD stage 3', status:'Chronic'},{code:'E11.9', desc:'Type 2 diabetes', status:'Chronic'}],
    vitalsHistory: [{date:'2025-02-10', temp:97.8, bps:118, bpd:72, hr:68, rr:18, wt:198, o2:95},{date:'2025-01-10', temp:97.6, bps:124, bpd:78, hr:72, rr:20, wt:205, o2:94}],
    visitHistory: [{date:'2025-02-10', type:'Follow-up', provider:'Dr. Garcia', reason:'CHF/AFib management'},{date:'2025-01-10', type:'Urgent', provider:'Dr. Garcia', reason:'Worsening dyspnea'},{date:'2024-12-01', type:'Follow-up', provider:'Dr. Garcia', reason:'Chronic disease management'}],
    notes: [{date:'2025-02-10', type:'SOAP Note', provider:'Dr. Garcia', content:'74yo male with CHF, AFib, CAD, CKD3, T2DM. INR today 2.4 (therapeutic). Weight down 7 lbs from last visit - good response to furosemide. O2 sat 95% on RA. Echo scheduled.'}],
    orders: [{id:'ord6', type:'Lab', detail:'INR/PT, BMP, BNP', priority:'Routine', status:'In Progress', result:''}],
    labProcs: [], appointments: [{date:'2025-03-10', time:'11:00', type:'Follow-up', provider:'Dr. Garcia', reason:'CHF/AFib management'}], 
    encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  },
  {
    id: 'MRN00011', fname: 'Margaret', lname: 'Hill', dob: '1942-05-19', gender: 'Female',
    phone: '(555) 667-5544', address: '310 Senior Way, Springfield, IL',
    insurance: 'Medicare + Supplemental', insId: 'MC112233', copay: 0, deductible: 0, deductibleMet: 0,
    checkedIn: false,
    allergies: [{allergen:'Codeine',reaction:'Confusion/Sedation',severity:'Severe'},{allergen:'NSAIDs',reaction:'Acute kidney injury',severity:'Severe'},{allergen:'Heparin',reaction:'HIT',severity:'Severe'}],
    meds: [{name:'Donepezil', dose:'10mg', freq:'Nightly', route:'Oral'},{name:'Memantine', dose:'20mg', freq:'Once daily', route:'Oral'},{name:'Escitalopram', dose:'5mg', freq:'Once daily', route:'Oral'},{name:'Omeprazole', dose:'20mg', freq:'Once daily', route:'Oral'},{name:'Colace', dose:'100mg', freq:'Twice daily', route:'Oral'},{name:'Calcium + D3', dose:'600mg/400IU', freq:'Twice daily', route:'Oral'}],
    problems: [{code:'G30.1', desc:"Alzheimer's disease with late onset", status:'Chronic'},{code:'M81.0', desc:'Osteoporosis without pathological fracture', status:'Chronic'},{code:'I10', desc:'Essential hypertension', status:'Chronic'},{code:'F32.0', desc:'Major depressive disorder, mild', status:'Active'},{code:'Z87.39', desc:'Personal history of other musculoskeletal disorders', status:'Active'}],
    vitalsHistory: [{date:'2025-02-12', temp:97.5, bps:138, bpd:80, hr:70, rr:16, wt:118, o2:97}],
    visitHistory: [{date:'2025-02-12', type:'Follow-up', provider:'Dr. Lee', reason:"Alzheimer's/geriatric management"},{date:'2024-11-15', type:'Follow-up', provider:'Dr. Lee', reason:'Cognitive assessment'},{date:'2024-09-01', type:'Urgent', provider:'Dr. Lee', reason:'Fall at home'}],
    notes: [{date:'2025-02-12', type:'Progress Note', provider:'Dr. Lee', content:"82yo female with Alzheimer's, osteoporosis, HTN, MDD. Caregiver present. MMSE 18/30. Donepezil/Memantine continued. No new falls. Low weight 118 lbs - nutritional consult placed. Safety evaluation done."},{date:'2024-09-01', type:'Nursing Note', provider:'RN Briggs', content:'Patient brought in by daughter after unwitnessed fall at home. Minor bruising R forearm, no fracture on X-ray. Fall risk education given to caregiver.'}],
    orders: [], labProcs: [], appointments: [{date:'2025-05-12', time:'10:30', type:'Follow-up', provider:'Dr. Lee', reason:'Quarterly geriatric review'}], 
    encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  }
];

let currentPid = null;
function getPt() { return patients.find(p => p.id === currentPid); }
function calcAge(dob) { const [y,mo,d] = dob.split("-"); const b = new Date(+y,+mo-1,+d), n = new Date(); let a = n.getFullYear()-b.getFullYear(); if(n < new Date(n.getFullYear(),b.getMonth(),b.getDate())) a--; return a; }
function calcAgeDisplay(dob) { const [y,mo,d] = dob.split("-"); const b = new Date(+y,+mo-1,+d), n = new Date(); let years = n.getFullYear()-b.getFullYear(); if(n < new Date(n.getFullYear(),b.getMonth(),b.getDate())) years--; if(years < 2) { let months = (n.getFullYear()-b.getFullYear())*12+(n.getMonth()-b.getMonth()); if(n.getDate()<b.getDate()) months--; if(months<=0) return "Newborn"; return months+" month"+(months===1?"":"s")+" old"; } return years+" years old"; }

// ===================== INIT =====================
window.onload = () => {
  const sel = document.getElementById('patient-select');
  patients.forEach(p => {
    const o = document.createElement('option');
    o.value = p.id;
    o.text = `${p.fname} ${p.lname} (${calcAge(p.dob)} y/o) ‚Äî ${p.id}`;
    sel.add(o);
  });
  // Set today as default for date inputs
  document.getElementById('appt-date').value = today;
  // First-load reminder ‚Äî shown once per session
  setTimeout(() => {
    toast('‚ÑπÔ∏è <strong>Before Exiting:</strong><br>This clinical simulation does not retain data after you exit.<br>Be sure to print the complete patient record for submission.', 'info');
  }, 1200);
};

// ===================== PATIENT SELECT =====================
function selectPatient(pid) {
  currentPid = pid;
  const pt = getPt();
  const badge = document.getElementById('checkin-badge');
  if (!pt) { badge.textContent = 'No Patient'; badge.className = 'status-badge checked-out'; showSection('patient-details'); return; }
  badge.textContent = pt.checkedIn ? '‚óè Checked In' : 'Checked Out';
  badge.className = 'status-badge ' + (pt.checkedIn ? 'checked-in' : 'checked-out');
  document.getElementById('checkout-content').innerHTML = '<p class="text-muted">Select a patient to view checkout.</p>';
  const deleteBox = document.getElementById('delete-confirm-box');
  if (deleteBox) deleteBox.innerHTML = '';
  showSection('patient-details');
}

function renderAll() {
  const active = document.querySelector('.nav-item.active')?.onclick?.toString().match(/'(.+?)'/)?.[1] || 'patient-details';
  // Never auto-render checkout on patient switch ‚Äî only render it when explicitly navigated to
  if (active === 'checkout') {
    renderSection('patient-details');
    showSection('patient-details');
  } else {
    renderSection(active);
  }
}

// ===================== NAVIGATION =====================
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.onclick && n.onclick.toString().includes("'" + name + "'")) n.classList.add('active');
  });
  renderSection(name);
}

function renderSection(name) {
  const pt = getPt();
  switch(name) {
    case 'patient-details': renderPatientDetails(pt); break;
    case 'visit-history': renderVisitHistory(pt); break;
    case 'problem-list': renderProblemList(pt); break;
    case 'vital-signs': renderVitals(pt); break;
    case 'allergies-meds': renderAllergiesMeds(pt); break;
    case 'clinical-notes': renderNotes(pt); break;
    case 'orders': renderOrders(pt); break;
    case 'lab-results': renderLabResults(pt); break;
    case 'lab-procedures': renderLabProcHistory(pt); break;
    case 'appointments': renderAppointments(pt); break;
    case 'encounter-form': loadEncounter(pt); setTimeout(function(){ initSignature(); initPedTab(pt); }, 50); break;
    case 'requisitions': renderRequisitions(pt); break;
    case 'visit-charges': renderCharges(pt); break;
    case 'checkout': renderCheckout(pt); break;
  }
}

// ===================== CHECK IN/OUT =====================
function doCheckin() {
  const pt = getPt(); if (!pt) { toast('Select a patient first'); return; }
  pt.checkedIn = true;
  document.getElementById('checkin-badge').textContent = '‚óè Checked In';
  document.getElementById('checkin-badge').className = 'status-badge checked-in';
  toast(`${pt.fname} ${pt.lname} checked in`);
}
function doCheckout() {
  const pt = getPt(); if (!pt) { toast('Select a patient first'); return; }
  pt.checkedIn = false;
  document.getElementById('checkin-badge').textContent = 'Checked Out';
  document.getElementById('checkin-badge').className = 'status-badge checked-out';
  toast(`${pt.fname} ${pt.lname} checked out`);
}

// ===================== PATIENT DETAILS =====================
function renderPatientDetails(pt) {
  const el = document.getElementById('patient-details-content');
  if (!pt) { el.innerHTML = '<p class="text-muted">Please select a patient.</p>'; return; }
  el.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="card-title" style="margin-bottom:0">Demographics</div>
        <div class="no-print" style="display:flex;gap:8px">
          <button class="btn btn-sm btn-primary" onclick="showEditPatientModal()">‚úè Edit Patient</button>
          <button class="btn btn-sm btn-danger" onclick="showDeleteConfirm()">üóë Delete Patient</button>
        </div>
      </div>
      <div id="delete-confirm-box"></div>
      <div class="card-grid">
        <div class="field-group"><div class="field-label">Full Name</div><div class="field-value" style="font-size:18px;font-weight:700">${pt.fname} ${pt.lname}</div></div>
        <div class="field-group"><div class="field-label">MRN</div><div class="field-value font-mono">${pt.id}</div></div>
        ${pt.guardian ? `<div class="field-group"><div class="field-label">Guardian</div><div class="field-value">${pt.guardian}</div></div>` : ''}
        <div class="field-group"><div class="field-label">Date of Birth</div><div class="field-value">${fmtDate(pt.dob)}</div></div>
        <div class="field-group"><div class="field-label">Age</div><div class="field-value">${calcAgeDisplay(pt.dob)}</div></div>
        <div class="field-group"><div class="field-label">Gender</div><div class="field-value">${pt.gender}</div></div>
        <div class="field-group"><div class="field-label">Status</div><div class="field-value"><span class="badge ${pt.checkedIn ? 'badge-green' : 'badge-gray'}">${pt.checkedIn ? 'Checked In' : 'Checked Out'}</span></div></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-title">Insurance</div>
        <div class="card-grid">
          <div class="field-group"><div class="field-label">Provider</div><div class="field-value">${pt.insurance}</div></div>
          <div class="field-group"><div class="field-label">Member ID</div><div class="field-value font-mono">${pt.insId}</div></div>
          <div class="field-group"><div class="field-label">Copay</div><div class="field-value">$${pt.copay.toFixed(2)}</div></div>
          <div class="field-group"><div class="field-label">Annual Deductible</div><div class="field-value">$${pt.deductible.toFixed(2)}</div></div>
          <div class="field-group"><div class="field-label">Deductible Met</div><div class="field-value">$${pt.deductibleMet.toFixed(2)}</div></div>
          <div class="field-group"><div class="field-label">Remaining</div><div class="field-value">${(pt.deductible - pt.deductibleMet) <= 0 ? '<span class="badge badge-green">Met</span>' : '$' + (pt.deductible - pt.deductibleMet).toFixed(2)}</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Contact Information</div>
        <div class="field-group" style="margin-bottom:10px"><div class="field-label">Phone</div><div class="field-value">${pt.phone}</div></div>
        <div class="field-group"><div class="field-label">Address</div><div class="field-value">${pt.address}</div></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-title">Active Problems (${pt.problems.filter(p=>p.status!=='Resolved').length})</div>
        ${pt.problems.filter(p=>p.status!=='Resolved').map(pr=>`<div style="margin-bottom:6px"><span class="badge badge-blue">${pr.code}</span> <span style="font-size:13px">${pr.desc}</span> <span class="badge badge-gray" style="font-size:10px">${pr.status}</span></div>`).join('') || '<p class="text-muted text-sm">None</p>'}
      </div>
      <div class="card">
        <div class="card-title">Current Medications (${pt.meds.length})</div>
        ${pt.meds.map(m=>`<div style="margin-bottom:5px;font-size:13px"><b>${m.name}</b> ${m.dose} ‚Äî ${m.freq}</div>`).join('') || '<p class="text-muted text-sm">None</p>'}
      </div>
    </div>
  `;
}

function showDeleteConfirm() {
  const pt = getPt(); if (!pt) return;
  const box = document.getElementById('delete-confirm-box');
  box.innerHTML = `
    <div class="confirm-box">
      <span style="flex:1">‚ö† Are you sure you want to delete <b>${pt.fname} ${pt.lname}</b>? This cannot be undone.</span>
      <button class="btn btn-danger btn-sm" onclick="deletePatient()">Yes, Delete</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('delete-confirm-box').innerHTML=''">Cancel</button>
    </div>`;
}

function deletePatient() {
  const pt = getPt(); if (!pt) return;
  const name = `${pt.fname} ${pt.lname}`;
  patients = patients.filter(p => p.id !== pt.id);
  // Remove from dropdown
  const sel = document.getElementById('patient-select');
  for (let i = 0; i < sel.options.length; i++) {
    if (sel.options[i].value === currentPid) { sel.remove(i); break; }
  }
  currentPid = null;
  sel.value = '';
  document.getElementById('checkin-badge').textContent = 'Checked Out';
  document.getElementById('checkin-badge').className = 'status-badge checked-out';
  renderPatientDetails(null);
  toast(`${name} has been deleted`);
}

function showEditPatientModal() {
  const pt = getPt(); if (!pt) return;
  document.getElementById('ep-fname').value = pt.fname;
  document.getElementById('ep-lname').value = pt.lname;
  document.getElementById('ep-dob').value = pt.dob;
  document.getElementById('ep-gender').value = pt.gender;
  document.getElementById('ep-guardian').value = pt.guardian || '';
  document.getElementById('ep-phone').value = pt.phone;
  document.getElementById('ep-address').value = pt.address;
  document.getElementById('ep-insurance').value = pt.insurance;
  document.getElementById('ep-insid').value = pt.insId;
  document.getElementById('ep-copay').value = pt.copay;
  document.getElementById('ep-deductible').value = pt.deductible;
  document.getElementById('ep-deductiblemet').value = pt.deductibleMet;
  document.getElementById('edit-patient-modal').style.display = 'flex';
}

function closeEditPatientModal() {
  document.getElementById('edit-patient-modal').style.display = 'none';
}

function saveEditPatient() {
  const pt = getPt(); if (!pt) return;
  pt.fname = document.getElementById('ep-fname').value.trim() || pt.fname;
  pt.lname = document.getElementById('ep-lname').value.trim() || pt.lname;
  pt.dob = document.getElementById('ep-dob').value || pt.dob;
  pt.gender = document.getElementById('ep-gender').value;
  pt.guardian = document.getElementById('ep-guardian').value.trim() || undefined;
  pt.phone = document.getElementById('ep-phone').value.trim() || pt.phone;
  pt.address = document.getElementById('ep-address').value.trim() || pt.address;
  pt.insurance = document.getElementById('ep-insurance').value.trim() || pt.insurance;
  pt.insId = document.getElementById('ep-insid').value.trim() || pt.insId;
  pt.copay = parseFloat(document.getElementById('ep-copay').value) || 0;
  pt.deductible = parseFloat(document.getElementById('ep-deductible').value) || 0;
  pt.deductibleMet = parseFloat(document.getElementById('ep-deductiblemet').value) || 0;
  // Update dropdown label
  const sel = document.getElementById('patient-select');
  for (let i = 0; i < sel.options.length; i++) {
    if (sel.options[i].value === pt.id) {
      sel.options[i].text = `${pt.fname} ${pt.lname} (${calcAge(pt.dob)} y/o) ‚Äî ${pt.id}`;
      break;
    }
  }
  closeEditPatientModal();
  renderPatientDetails(pt);
  toast('Patient details updated');
}

// ===================== VISIT HISTORY =====================
function renderVisitHistory(pt) {
  const el = document.getElementById('visit-history-table');
  if (!pt || !pt.visitHistory.length) { el.innerHTML = '<p class="text-muted text-sm">No visit history.</p>'; return; }
  el.innerHTML = `<table><thead><tr><th>Date</th><th>Visit Type</th><th>Provider</th><th>Reason</th></tr></thead><tbody>${pt.visitHistory.map(v=>`<tr><td>${fmtDate(v.date)}</td><td>${v.type}</td><td>${v.provider}</td><td>${v.reason}</td></tr>`).join('')}</tbody></table>`;
}

// ===================== PROBLEM LIST =====================
function renderProblemList(pt) {
  const el = document.getElementById('problem-list-table');
  if (!pt || !pt.problems.length) { el.innerHTML = '<p class="text-muted text-sm">No problems on file.</p>'; return; }
  el.innerHTML = `<table><thead><tr><th>ICD-10</th><th>Description</th><th>Status</th><th class="no-print">Actions</th></tr></thead><tbody>${pt.problems.map((pr,i)=>`<tr><td class="font-mono">${pr.code}</td><td>${pr.desc}</td><td><span class="badge ${pr.status==='Active'?'badge-red':pr.status==='Chronic'?'badge-purple':'badge-green'}">${pr.status}</span></td><td class="no-print"><button class="btn btn-xs btn-danger" onclick="deleteProblem(${i})">Delete</button></td></tr>`).join('')}</tbody></table>`;
}
function addProblem() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const code = document.getElementById('problem-code').value.trim();
  const desc = document.getElementById('problem-desc').value.trim();
  const status = document.getElementById('problem-status').value;
  if (!code || !desc) { toast('Fill in ICD-10 code and description'); return; }
  pt.problems.push({code, desc, status});
  document.getElementById('problem-code').value = '';
  document.getElementById('problem-desc').value = '';
  renderProblemList(pt);
  toast('Problem added');
}
function deleteProblem(i) {
  const pt = getPt(); if (!pt) return;
  pt.problems.splice(i,1);
  renderProblemList(pt);
  toast('Problem removed');
}

// ===================== VITALS =====================
function renderVitals(pt) {
  const el = document.getElementById('vitals-history-table');
  if (!pt || !pt.vitalsHistory.length) { el.innerHTML = '<p class="text-muted text-sm">No vitals on record.</p>'; return; }
  const latest = pt.vitalsHistory[pt.vitalsHistory.length - 1];
  // Vitals cards for latest
  const cards = document.getElementById('vitals-history-card');
  el.innerHTML = `
    <div class="vitals-grid" style="margin-bottom:16px">
      <div class="vital-card"><div class="name">Temp</div><div class="val">${latest.temp}</div><div class="unit">¬∞F</div></div>
      <div class="vital-card"><div class="name">Blood Pressure</div><div class="val">${latest.bps}/${latest.bpd}</div><div class="unit">mmHg</div></div>
      <div class="vital-card"><div class="name">Heart Rate</div><div class="val">${latest.hr}</div><div class="unit">bpm</div></div>
      <div class="vital-card"><div class="name">Resp Rate</div><div class="val">${latest.rr}</div><div class="unit">/min</div></div>
      <div class="vital-card"><div class="name">Weight</div><div class="val">${latest.wt}</div><div class="unit">lbs</div></div>
      <div class="vital-card"><div class="name">Height</div><div class="val">${latest.ht||'‚Äî'}</div><div class="unit">in</div></div>
      <div class="vital-card" style="${latest.bmi ? (latest.bmi<18.5?'border-color:#1e40af':latest.bmi<25?'border-color:#047857':latest.bmi<30?'border-color:#92400e':'border-color:#9f1239') : ''}"><div class="name">BMI</div><div class="val" style="${latest.bmi ? (latest.bmi<18.5?'color:#1e40af':latest.bmi<25?'color:#047857':latest.bmi<30?'color:#92400e':'color:#9f1239') : ''}">${latest.bmi||'‚Äî'}</div><div class="unit">${latest.bmi ? (latest.bmi<18.5?'Underweight':latest.bmi<25?'Normal':latest.bmi<30?'Overweight':'Obese') : ''}</div></div>
      <div class="vital-card"><div class="name">Vision OD</div><div class="val" style="font-size:14px">${latest.od||'‚Äî'}</div><div class="unit">${latest.corrected||''}</div></div>
      <div class="vital-card"><div class="name">Vision OS</div><div class="val" style="font-size:14px">${latest.os||'‚Äî'}</div><div class="unit">&nbsp;</div></div>
      <div class="vital-card"><div class="name">O2 Sat</div><div class="val">${latest.o2}</div><div class="unit">%</div></div>
    </div>
    <div class="card-title">History</div>
    <table><thead><tr><th>Date</th><th>Temp</th><th>BP</th><th>HR</th><th>RR</th><th>Wt</th><th>Ht</th><th>BMI</th><th>Vision OD</th><th>Vision OS</th><th>O2%</th></tr></thead><tbody>
    ${[...pt.vitalsHistory].reverse().map(v=>`<tr><td>${fmtDate(v.date)}</td><td>${v.temp}</td><td>${v.bps}/${v.bpd}</td><td>${v.hr}</td><td>${v.rr}</td><td>${v.wt}</td><td>${v.ht||'‚Äî'}</td><td>${v.bmi||'‚Äî'}</td><td>${v.od||'‚Äî'}</td><td>${v.os||'‚Äî'}</td><td>${v.o2}</td></tr>`).join('')}
    </tbody></table>
  `;
}
function calcBMI() {
  const wt = parseFloat(document.getElementById('v-wt').value);
  const ht = parseFloat(document.getElementById('v-ht').value);
  const box = document.getElementById('bmi-result');
  if (!wt || !ht) { box.style.display = 'none'; return; }
  const bmi = (703 * wt / (ht * ht)).toFixed(1);
  let cat, color;
  if (bmi < 18.5) { cat = 'Underweight'; color = '#1e40af'; }
  else if (bmi < 25) { cat = 'Normal weight'; color = '#047857'; }
  else if (bmi < 30) { cat = 'Overweight'; color = '#92400e'; }
  else { cat = 'Obese'; color = '#9f1239'; }
  box.style.display = 'block';
  box.style.color = color;
  box.style.borderColor = color;
  box.style.background = color + '11';
  box.innerHTML = `BMI: ${bmi} &nbsp;‚Äî&nbsp; <span style="font-weight:400">${cat}</span> &nbsp;|&nbsp; <span style="font-size:11px;font-weight:400;color:var(--text3)">Underweight &lt;18.5 &nbsp;|&nbsp; Normal 18.5‚Äì24.9 &nbsp;|&nbsp; Overweight 25‚Äì29.9 &nbsp;|&nbsp; Obese ‚â•30</span>`;
}

function saveVitals() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const wt = parseFloat(document.getElementById('v-wt').value) || 0;
  const ht = parseFloat(document.getElementById('v-ht').value) || 0;
  const bmi = (wt && ht) ? parseFloat((703 * wt / (ht * ht)).toFixed(1)) : 0;
  const v = {
    date: today,
    temp: parseFloat(document.getElementById('v-temp').value) || 0,
    bps: parseInt(document.getElementById('v-bps').value) || 0,
    bpd: parseInt(document.getElementById('v-bpd').value) || 0,
    hr: parseInt(document.getElementById('v-hr').value) || 0,
    rr: parseInt(document.getElementById('v-rr').value) || 0,
    wt: wt, ht: ht, bmi: bmi,
    od: document.getElementById('v-od').value.trim(),
    os: document.getElementById('v-os').value.trim(),
    corrected: document.getElementById('v-corrected').value,
    o2: parseInt(document.getElementById('v-o2').value) || 0
  };
  if (!v.temp && !v.bps) { toast('Enter at least one vital sign'); return; }
  pt.vitalsHistory.push(v);
  ['v-temp','v-bps','v-bpd','v-hr','v-rr','v-wt','v-ht','v-od','v-os','v-o2'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('v-corrected').value = '';
  document.getElementById('bmi-result').style.display = 'none';
  renderVitals(pt);
  toast('Vitals saved');
}

// ===================== PAIN SCALE =====================
function setPain(n) {
  const colors = ['#64748b','#22c55e','#4ade80','#a3e635','#facc15','#fb923c','#f97316','#ef4444','#dc2626','#b91c1c','#7f1d1d'];
  const labels = ['No Pain','Very Mild','Mild','Moderate Mild','Moderate','Moderate Severe','Somewhat Severe','Severe','Very Severe','Nearly Unbearable','Worst Imaginable'];
  const el = document.getElementById('pain-display');
  el.innerHTML = `<span style="color:${colors[n]}">${n}/10</span> <span style="font-size:12px;font-weight:400;color:var(--text2)">${labels[n]}</span>`;
}

// ===================== PHQ-2 DEPRESSION SCREEN =====================
function calcPHQ() {
  const q1 = document.querySelector('input[name="phq1"]:checked');
  const q2 = document.querySelector('input[name="phq2"]:checked');
  if (!q1 || !q2) return;
  const score = parseInt(q1.value) + parseInt(q2.value);
  const el = document.getElementById('phq-result');
  el.style.display = 'block';
  if (score >= 3) {
    el.style.background = '#fff1f2'; el.style.border = '1px solid #fda4af'; el.style.color = '#9f1239';
    el.innerHTML = `PHQ-2 Score: <strong>${score}/6</strong> ‚Äî <span>Positive screen. Consider full PHQ-9 assessment. Patient may benefit from further evaluation for depression.</span>`;
  } else {
    el.style.background = '#f0fdf4'; el.style.border = '1px solid #86efac'; el.style.color = '#047857';
    el.innerHTML = `PHQ-2 Score: <strong>${score}/6</strong> ‚Äî <span>Negative screen. Low likelihood of depression at this time.</span>`;
  }
}

// ===================== CONSENT SIGNATURE =====================
let isDrawing = false, lastX = 0, lastY = 0;
function initSignature() {
  const canvas = document.getElementById('consent-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#0f4c81'; ctx.lineWidth = 2; ctx.lineCap = 'round';
  const getPos = (e) => {
    const r = canvas.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    return [src.clientX - r.left, src.clientY - r.top];
  };
  canvas.onmousedown = canvas.ontouchstart = (e) => { e.preventDefault(); isDrawing = true; [lastX, lastY] = getPos(e); };
  canvas.onmousemove = canvas.ontouchmove = (e) => {
    e.preventDefault();
    if (!isDrawing) return;
    const [x, y] = getPos(e);
    ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
    [lastX, lastY] = [x, y];
  };
  canvas.onmouseup = canvas.ontouchend = () => { isDrawing = false; };
  canvas.onmouseleave = () => { isDrawing = false; };
}
function clearSignature() {
  const canvas = document.getElementById('consent-canvas');
  if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}

// ===================== ALLERGIES & MEDS =====================
function renderAllergiesMeds(pt) {
  renderAllergyList(pt);
  renderMedList(pt);
}
function renderAllergyList(pt) {
  const el = document.getElementById('allergy-list');
  if (!pt || !pt.allergies.length) { el.innerHTML = '<p class="text-muted text-sm">No allergies on file.</p>'; return; }
  el.innerHTML = `<table><thead><tr><th>Allergen</th><th>Reaction</th><th>Severity</th><th class="no-print">Action</th></tr></thead><tbody>${pt.allergies.map((a,i)=>`<tr><td><b>${a.allergen}</b></td><td>${a.reaction}</td><td><span class="badge ${a.severity==='Severe'?'badge-red':a.severity==='Moderate'?'badge-yellow':'badge-green'}">${a.severity}</span></td><td class="no-print"><button class="btn btn-xs btn-danger" onclick="deleteAllergy(${i})">Del</button></td></tr>`).join('')}</tbody></table>`;
}
function renderMedList(pt) {
  const el = document.getElementById('med-list');
  if (!pt || !pt.meds.length) { el.innerHTML = '<p class="text-muted text-sm">No medications on file.</p>'; return; }
  el.innerHTML = `<table><thead><tr><th>Medication</th><th>Dose</th><th>Frequency</th><th>Route</th><th class="no-print">Action</th></tr></thead><tbody>${pt.meds.map((m,i)=>`<tr><td><b>${m.name}</b></td><td>${m.dose}</td><td>${m.freq}</td><td>${m.route}</td><td class="no-print"><button class="btn btn-xs btn-danger" onclick="deleteMed(${i})">Del</button></td></tr>`).join('')}</tbody></table>`;
}
function toggleAllergyForm() { const f = document.getElementById('allergy-form'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
function toggleMedForm() { const f = document.getElementById('med-form'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
function addAllergy() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const allergen = document.getElementById('allergy-name').value.trim();
  const reaction = document.getElementById('allergy-reaction').value.trim();
  const severity = document.getElementById('allergy-severity').value;
  if (!allergen) { toast('Enter allergen name'); return; }
  pt.allergies.push({allergen, reaction, severity});
  document.getElementById('allergy-name').value = '';
  document.getElementById('allergy-reaction').value = '';
  renderAllergyList(pt);
  toggleAllergyForm();
  toast('Allergy added');
}
function deleteAllergy(i) { const pt = getPt(); pt.allergies.splice(i,1); renderAllergyList(pt); toast('Allergy removed'); }
function addMed() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const name = document.getElementById('med-name').value.trim();
  const dose = document.getElementById('med-dose').value.trim();
  const freq = document.getElementById('med-freq').value.trim();
  const route = document.getElementById('med-route').value.trim();
  if (!name) { toast('Enter medication name'); return; }
  pt.meds.push({name, dose, freq, route});
  ['med-name','med-dose','med-freq','med-route'].forEach(id => document.getElementById(id).value = '');
  renderMedList(pt);
  toggleMedForm();
  toast('Medication added');
}
function deleteMed(i) { const pt = getPt(); pt.meds.splice(i,1); renderMedList(pt); toast('Medication removed'); }

// ===================== CLINICAL NOTES =====================
function renderNotes(pt) {
  const el = document.getElementById('notes-list');
  if (!pt || !pt.notes.length) { el.innerHTML = '<p class="text-muted text-sm">No notes on file.</p>'; return; }
  const reversed = [...pt.notes].map((n,i)=>({...n, origIndex: i})).reverse();
  el.innerHTML = reversed.map(n=>`
    <div class="card" style="border-left:4px solid var(--primary)" id="note-card-${n.origIndex}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div><span class="badge badge-blue">${n.type}</span> <span style="font-weight:600">${n.provider}</span></div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="text-sm text-muted">${fmtDate(n.date)}</span>
          <button class="btn btn-xs btn-secondary no-print" onclick="editNote(${n.origIndex})">‚úè Edit</button>
          <button class="btn btn-xs btn-danger no-print" onclick="deleteNote(${n.origIndex})">üóë Delete</button>
        </div>
      </div>
      <div id="note-view-${n.origIndex}" style="white-space:pre-wrap;font-size:13px;line-height:1.6">${n.content}</div>
      <div id="note-edit-${n.origIndex}" style="display:none">
        <div class="form-row" style="margin-bottom:8px">
          <div class="form-group">
            <label>Note Type</label>
            <select id="note-edit-type-${n.origIndex}">
              <option ${n.type==='SOAP Note'?'selected':''}>SOAP Note</option>
              <option ${n.type==='Progress Note'?'selected':''}>Progress Note</option>
              <option ${n.type==='Nursing Note'?'selected':''}>Nursing Note</option>
              <option ${n.type==='Consultation Note'?'selected':''}>Consultation Note</option>
              <option ${n.type==='Discharge Summary'?'selected':''}>Discharge Summary</option>
              <option ${n.type==='Phone Encounter'?'selected':''}>Phone Encounter</option>
            </select>
          </div>
          <div class="form-group"><label>Provider</label><input id="note-edit-provider-${n.origIndex}" value="${n.provider}"></div>
        </div>
        <textarea id="note-edit-content-${n.origIndex}" rows="5" style="margin-bottom:8px">${n.content}</textarea>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary btn-sm" onclick="saveNoteEdit(${n.origIndex})">üíæ Save</button>
          <button class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${n.origIndex})">Cancel</button>
        </div>
      </div>
    </div>
  `).join('');
}

function editNote(i) {
  document.getElementById(`note-view-${i}`).style.display = 'none';
  document.getElementById(`note-edit-${i}`).style.display = 'block';
}

function cancelNoteEdit(i) {
  document.getElementById(`note-view-${i}`).style.display = 'block';
  document.getElementById(`note-edit-${i}`).style.display = 'none';
}

function saveNoteEdit(i) {
  const pt = getPt(); if (!pt) return;
  pt.notes[i].type = document.getElementById(`note-edit-type-${i}`).value;
  pt.notes[i].provider = document.getElementById(`note-edit-provider-${i}`).value.trim() || 'Unknown Provider';
  pt.notes[i].content = document.getElementById(`note-edit-content-${i}`).value.trim();
  renderNotes(pt);
  toast('Note updated');
}

function deleteNote(i) {
  const pt = getPt(); if (!pt) return;
  pt.notes.splice(i, 1);
  renderNotes(pt);
  toast('Note deleted');
}

function addNote() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const type = document.getElementById('note-type').value;
  const provider = document.getElementById('note-provider').value.trim();
  const content = document.getElementById('note-content').value.trim();
  if (!content) { toast('Enter note content'); return; }
  pt.notes.push({date: today, type, provider: provider || 'Unknown Provider', content});
  document.getElementById('note-content').value = '';
  document.getElementById('note-provider').value = '';
  renderNotes(pt);
  toast('Note saved');
}

// ===================== ORDERS =====================
function renderOrders(pt) {
  const el = document.getElementById('orders-list');
  if (!pt || !pt.orders.length) { el.innerHTML = '<p class="text-muted text-sm">No active orders.</p>'; return; }
  el.innerHTML = pt.orders.map((o,i) => `
    <div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px;background:var(--surface)">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span class="badge badge-blue">${o.type}</span>
        <span style="font-weight:600;font-size:14px;flex:1">${o.detail}</span>
        <span class="badge ${o.priority==='STAT'?'badge-red':o.priority==='Urgent'?'badge-yellow':'badge-gray'}">${o.priority}</span>
        ${statusBadge(o.status)}
        <div class="no-print" style="display:flex;gap:6px">
          ${o.status === 'Pending' ? `<button class="btn btn-xs btn-primary" onclick="progressOrder(${i},'In Progress')">‚ñ∂ Start</button>` : ''}
          ${o.status === 'In Progress' ? `<button class="btn btn-xs btn-success" onclick="toggleResultEntry(${i})">‚úì Mark Done</button>` : ''}
          ${o.status === 'Completed' ? '<span class="badge badge-green">Complete</span>' : ''}
          <button class="btn btn-xs btn-danger" onclick="deleteOrder(${i})">Del</button>
        </div>
      </div>
      ${o.status === 'In Progress' ? `
        <div id="result-entry-${i}" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
          <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">Enter Result / Findings (optional)</label>
          <textarea id="result-text-${i}" rows="2" placeholder="e.g. WBC 8.2, Hgb 13.4 ... or leave blank to mark complete without results" style="margin-bottom:8px"></textarea>
          <div style="display:flex;gap:8px">
            <button class="btn btn-sm btn-success" onclick="completeOrder(${i})">‚úì Confirm Complete</button>
            <button class="btn btn-sm btn-secondary" onclick="toggleResultEntry(${i})">Cancel</button>
          </div>
        </div>` : ''}
      ${o.status === 'Completed' && o.result ? `
        <div style="margin-top:8px;padding:8px;background:var(--surface2);border-radius:6px;font-size:13px;font-family:'IBM Plex Mono',monospace;white-space:pre-wrap">${o.result}</div>` : ''}
    </div>`).join('');
}

function statusBadge(s) {
  if (s==='Pending') return '<span class="badge badge-yellow">Pending</span>';
  if (s==='In Progress') return '<span class="badge badge-blue">In Progress</span>';
  return '<span class="badge badge-green">Completed</span>';
}

function toggleResultEntry(i) {
  const el = document.getElementById(`result-entry-${i}`);
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function addOrder() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const type = document.getElementById('order-type').value;
  const detail = document.getElementById('order-detail').value.trim();
  const priority = document.getElementById('order-priority').value;
  if (!detail) { toast('Enter order details'); return; }
  pt.orders.push({id:'ord'+Date.now(), type, detail, priority, status:'Pending', result:''});
  document.getElementById('order-detail').value = '';
  renderOrders(pt);
  toast('Order created');
}

function progressOrder(i, status) {
  const pt = getPt(); pt.orders[i].status = status; renderOrders(pt); toast('Order status updated');
}

function completeOrder(i) {
  const pt = getPt(); if (!pt) return;
  const resultEl = document.getElementById(`result-text-${i}`);
  pt.orders[i].result = resultEl ? resultEl.value.trim() : '';
  pt.orders[i].status = 'Completed';
  renderOrders(pt);
  renderLabResults(pt);
  toast('Order marked complete');
}

function deleteOrder(i) { const pt = getPt(); pt.orders.splice(i,1); renderOrders(pt); toast('Order removed'); }

// ===================== RESULTS =====================
function renderLabResults(pt) {
  const el = document.getElementById('lab-results-content');
  if (!pt) { el.innerHTML = '<p class="text-muted text-sm">No patient selected.</p>'; return; }

  // Gather completed orders
  const completedOrders = pt.orders.filter(o => o.status === 'Completed');

  // Gather completed lab procs (manual + structured)
  const completedProcs = (pt.labProcs || []);

  if (!completedOrders.length && !completedProcs.length) {
    el.innerHTML = '<p class="text-muted text-sm">No results yet. Complete orders in Orders & Workflow, or enter results in Labs & Procedures.</p>';
    return;
  }

  let html = '';

  if (completedOrders.length) {
    html += `<div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">From Orders</div>`;
    html += `<table style="margin-bottom:20px"><thead><tr><th>Type</th><th>Order</th><th>Result / Findings</th></tr></thead><tbody>
    ${completedOrders.map(o=>`<tr>
      <td><span class="badge badge-blue">${o.type}</span></td>
      <td style="font-weight:600">${o.detail}</td>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;white-space:pre-wrap">${o.result || '<span class="text-muted">No result entered</span>'}</td>
    </tr>`).join('')}
    </tbody></table>`;
  }

  if (completedProcs.length) {
    html += `<div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">From Labs & Procedures</div>`;
    html += [...completedProcs].reverse().map(lp => {
      if (lp.entryType === 'manual') {
        return `<div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;background:var(--surface)">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span class="badge badge-blue">${lp.resultType}</span>
            <span style="font-weight:600">${lp.name}</span>
            <span class="badge ${lp.status==='Final'?'badge-green':lp.status==='Preliminary'?'badge-yellow':lp.status==='Corrected'?'badge-purple':'badge-gray'}">${lp.status}</span>
            <span class="text-sm text-muted" style="margin-left:auto">${lp.date} ‚Äî ${lp.provider}</span>
          </div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;white-space:pre-wrap">${lp.result}</div>
        </div>`;
      }
      const typeLabel = lp.type==='urinalysis'?'Urinalysis':lp.type==='preg'?'Pregnancy Test':'POC Glucose';
      return `<div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;background:var(--surface)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <span class="badge badge-purple">${typeLabel}</span>
          <span class="text-sm text-muted" style="margin-left:auto">${lp.date} ‚Äî ${lp.provider}</span>
        </div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;white-space:pre-wrap;margin-bottom:4px">${lp.result}</div>
        ${lp.interpretation ? `<div style="margin-top:6px;padding:8px;background:${lp.interpretation.includes('üö®')?'#fee2e8':lp.interpretation.includes('‚ö†')?'#fff7d6':'#d4f8ed'};border-radius:6px;font-size:12px">${lp.interpretation}</div>` : ''}
      </div>`;
    }).join('');
  }

  el.innerHTML = html;
}

// ===================== LABS & PROCEDURES =====================
function renderLabProcForm() {
  const type = document.getElementById('lab-proc-type').value;
  const el = document.getElementById('lab-proc-form');
  if (!type) { el.innerHTML = ''; return; }
  if (type === 'urinalysis') {
    el.innerHTML = `
      <div class="card" style="background:var(--surface2)">
        <div class="card-title">Urinalysis (Dipstick) Parameters</div>
        <div class="form-row">
          <div class="form-group"><label>Glucose</label><select id="ua-glucose"><option>Negative</option><option>Trace</option><option>1+</option><option>2+</option><option>3+</option><option>4+</option></select></div>
          <div class="form-group"><label>Protein</label><select id="ua-protein"><option>Negative</option><option>Trace</option><option>1+</option><option>2+</option><option>3+</option></select></div>
          <div class="form-group"><label>Nitrites</label><select id="ua-nitrites"><option>Negative</option><option>Positive</option></select></div>
          <div class="form-group"><label>pH</label><select id="ua-ph"><option>5.0</option><option>6.0</option><option>7.0</option><option>7.5</option><option>8.0</option></select></div>
          <div class="form-group"><label>Leukocyte Esterase</label><select id="ua-le"><option>Negative</option><option>Trace</option><option>1+</option><option>2+</option><option>3+</option></select></div>
          <div class="form-group"><label>Appearance</label><select id="ua-appear"><option>Clear</option><option>Slightly cloudy</option><option>Cloudy</option><option>Turbid</option></select></div>
        </div>
      </div>`;
  } else if (type === 'preg') {
    el.innerHTML = `
      <div class="card" style="background:var(--surface2)">
        <div class="card-title">Pregnancy Test (hCG)</div>
        <div class="form-row">
          <div class="form-group"><label>Test Method</label>
            <select id="preg-method" onchange="toggleHcgQuant()">
              <option value="qual">Qualitative</option><option value="quant">Quantitative</option>
            </select>
          </div>
          <div class="form-group" id="preg-qual-wrap"><label>Result</label>
            <select id="preg-qual"><option>Negative</option><option>Positive</option></select>
          </div>
          <div class="form-group" id="preg-quant-wrap" style="display:none"><label>hCG Level (mIU/mL)</label>
            <input id="preg-quant" type="number" placeholder="e.g. 1500">
          </div>
        </div>
      </div>`;
  } else if (type === 'glucose') {
    el.innerHTML = `
      <div class="card" style="background:var(--surface2)">
        <div class="card-title">Point-of-Care Glucose</div>
        <div class="form-row">
          <div class="form-group"><label>Fingerstick Glucose (mg/dL)</label><input id="poc-glucose" type="number" placeholder="e.g. 98"></div>
          <div class="form-group"><label>Collection Time</label><select id="poc-timing"><option>Fasting</option><option>Random</option><option>Post-prandial 2hr</option><option>Pre-meal</option></select></div>
        </div>
        <div id="glucose-alert"></div>
      </div>`;
  }
}

function toggleHcgQuant() {
  const m = document.getElementById('preg-method').value;
  document.getElementById('preg-qual-wrap').style.display = m === 'qual' ? 'block' : 'none';
  document.getElementById('preg-quant-wrap').style.display = m === 'quant' ? 'block' : 'none';
}

function saveLabProc() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const type = document.getElementById('lab-proc-type').value;
  const provider = document.getElementById('lab-proc-provider').value.trim() || 'Unknown';
  if (!type) { toast('Select a test type'); return; }
  let result = '', interpretation = '';
  if (type === 'urinalysis') {
    const glucose = document.getElementById('ua-glucose').value;
    const protein = document.getElementById('ua-protein').value;
    const nitrites = document.getElementById('ua-nitrites').value;
    const ph = document.getElementById('ua-ph').value;
    const le = document.getElementById('ua-le').value;
    const appear = document.getElementById('ua-appear').value;
    result = `Glucose: ${glucose} | Protein: ${protein} | Nitrites: ${nitrites} | pH: ${ph} | Leuk Est: ${le} | Appearance: ${appear}`;
    if (nitrites === 'Positive' || le !== 'Negative') interpretation = '‚ö† Possible UTI ‚Äî nitrites/leukocyte esterase abnormal. Consider urine culture.';
    if (glucose !== 'Negative') interpretation += ' ‚ö† Glycosuria noted ‚Äî evaluate blood glucose.';
  } else if (type === 'preg') {
    const method = document.getElementById('preg-method').value;
    if (method === 'qual') {
      result = `hCG Qualitative: ${document.getElementById('preg-qual').value}`;
      interpretation = document.getElementById('preg-qual').value === 'Positive' ? '‚úì Positive pregnancy test.' : '‚úì Negative pregnancy test.';
    } else {
      const val = document.getElementById('preg-quant').value;
      result = `hCG Quantitative: ${val} mIU/mL`;
      if (val < 5) interpretation = '‚úì hCG < 5 mIU/mL ‚Äî Negative.';
      else if (val < 1000) interpretation = '‚ö† hCG positive - early pregnancy or other causes. Correlate clinically.';
      else interpretation = '‚úì hCG elevated - consistent with intrauterine pregnancy. Correlate clinically.';
    }
  } else if (type === 'glucose') {
    const val = parseFloat(document.getElementById('poc-glucose').value);
    const timing = document.getElementById('poc-timing').value;
    result = `POC Glucose: ${val} mg/dL (${timing})`;
    if (val < 70) interpretation = 'üö® CRITICAL LOW ‚Äî Hypoglycemia (< 70 mg/dL). Treat immediately with fast-acting carbohydrates.';
    else if (val < 100 && timing === 'Fasting') interpretation = '‚úì Normal fasting glucose.';
    else if (val > 200) interpretation = '‚ö† Significantly elevated glucose. Evaluate for hyperglycemia/DKA.';
    else if (val > 126 && timing === 'Fasting') interpretation = '‚ö† Fasting glucose ‚â• 126 mg/dL ‚Äî diagnostic for diabetes per ADA criteria.';
    else interpretation = '‚úì Glucose within acceptable range.';
  }
  pt.labProcs.push({date: ts(), type, provider, result, interpretation});
  document.getElementById('lab-proc-type').value = '';
  document.getElementById('lab-proc-form').innerHTML = '';
  renderLabProcHistory(pt);
  renderLabResults(pt);
  toast('Lab procedure saved');
}

function renderLabProcHistory(pt) {
  const el = document.getElementById('lab-proc-history');
  if (!pt || !pt.labProcs.length) { el.innerHTML = '<p class="text-muted text-sm">No labs or procedures recorded.</p>'; return; }
  el.innerHTML = [...pt.labProcs].reverse().map((lp, ri) => {
    const origIndex = pt.labProcs.length - 1 - ri;
    if (lp.entryType === 'manual') {
      return `
        <div class="card" style="margin-bottom:10px;border-left:4px solid var(--accent)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="display:flex;gap:8px;align-items:center">
              <span class="badge badge-blue">${lp.resultType}</span>
              <span style="font-weight:600;font-size:13px">${lp.name}</span>
              <span class="badge ${lp.status==='Final'?'badge-green':lp.status==='Preliminary'?'badge-yellow':lp.status==='Corrected'?'badge-purple':'badge-gray'}">${lp.status}</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="text-sm text-muted">${lp.date} ‚Äî ${lp.provider}</span>
              <button class="btn btn-xs btn-danger no-print" onclick="deleteLabProc(${origIndex})">üóë Delete</button>
            </div>
          </div>
          <div style="white-space:pre-wrap;font-size:13px;line-height:1.6;font-family:'IBM Plex Mono',monospace">${lp.result}</div>
        </div>`;
    }
    return `
      <div class="card" style="margin-bottom:10px;border-left:4px solid var(--purple)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <span class="badge badge-purple">${lp.type==='urinalysis'?'Urinalysis':lp.type==='preg'?'Pregnancy Test':'POC Glucose'}</span>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="text-sm text-muted">${lp.date} ‚Äî ${lp.provider}</span>
            <button class="btn btn-xs btn-danger no-print" onclick="deleteLabProc(${origIndex})">üóë Delete</button>
          </div>
        </div>
        <div class="font-mono text-sm" style="margin-bottom:4px">${lp.result}</div>
        ${lp.interpretation ? `<div style="margin-top:6px;padding:8px;background:${lp.interpretation.includes('üö®')?'#fee2e8':lp.interpretation.includes('‚ö†')?'#fff7d6':'#d4f8ed'};border-radius:6px;font-size:12px">${lp.interpretation}</div>` : ''}
      </div>`;
  }).join('');
}

function deleteLabProc(i) {
  const pt = getPt(); if (!pt) return;
  pt.labProcs.splice(i, 1);
  renderLabProcHistory(pt);
  toast('Entry deleted');
}

function saveManualResult() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const resultType = document.getElementById('manual-result-type').value;
  const name = document.getElementById('manual-result-name').value.trim();
  const provider = document.getElementById('manual-result-provider').value.trim();
  const result = document.getElementById('manual-result-content').value.trim();
  const status = document.getElementById('manual-result-status').value;
  if (!name || !result) { toast('Enter test name and result'); return; }
  pt.labProcs.push({ entryType: 'manual', resultType, name, provider: provider || 'Unknown', result, status, date: ts(), interpretation: '' });
  document.getElementById('manual-result-name').value = '';
  document.getElementById('manual-result-provider').value = '';
  document.getElementById('manual-result-content').value = '';
  renderLabProcHistory(pt);
  renderLabResults(pt);
  toast('Result saved');
}

// ===================== APPOINTMENTS =====================
function renderAppointments(pt) {
  const el = document.getElementById('appointments-list');
  if (!pt || !pt.appointments.length) { el.innerHTML = '<p class="text-muted text-sm">No appointments scheduled.</p>'; return; }
  el.innerHTML = `<table><thead><tr><th>Date</th><th>Time</th><th>Type</th><th>Provider</th><th>Reason</th><th class="no-print">Action</th></tr></thead><tbody>
  ${pt.appointments.map((a,i)=>`<tr><td>${fmtDate(a.date)}</td><td>${a.time}</td><td>${a.type}</td><td>${a.provider}</td><td>${a.reason}</td><td class="no-print"><button class="btn btn-xs btn-danger" onclick="deleteAppt(${i})">Cancel</button></td></tr>`).join('')}
  </tbody></table>`;
}
function addAppointment() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const date = document.getElementById('appt-date').value;
  const time = document.getElementById('appt-time').value;
  const type = document.getElementById('appt-type').value;
  const provider = document.getElementById('appt-provider').value.trim();
  const reason = document.getElementById('appt-reason').value.trim();
  if (!date || !reason) { toast('Enter date and reason'); return; }
  pt.appointments.push({date, time, type, provider, reason});
  document.getElementById('appt-reason').value = '';
  document.getElementById('appt-provider').value = '';
  renderAppointments(pt);
  toast('Appointment scheduled');
}
function deleteAppt(i) { const pt = getPt(); pt.appointments.splice(i,1); renderAppointments(pt); toast('Appointment cancelled'); }

// ===================== ENCOUNTER FORM =====================
function loadEncounter(pt) {
  if (!pt) return;
  document.getElementById('enc-cc').value = pt.encounter.cc || '';
  document.getElementById('enc-hpi').value = pt.encounter.hpi || '';
  document.getElementById('enc-ap').value = pt.encounter.ap || '';
}
function saveEncounter() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  pt.encounter.cc = document.getElementById('enc-cc').value;
  pt.encounter.hpi = document.getElementById('enc-hpi').value;
  pt.encounter.ap = document.getElementById('enc-ap').value;
  toast('Encounter saved');
}

// ===================== REQUISITIONS =====================
function renderRequisitions(pt) {
  const el = document.getElementById('req-list');
  if (!pt || !pt.requisitions.length) { el.innerHTML = '<p class="text-muted text-sm">No tasks.</p>'; updateReqProgress([]); return; }
  el.innerHTML = pt.requisitions.map((r,i)=>`
    <div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border);${r.done?'opacity:.6':''}">
      <input type="checkbox" ${r.done?'checked':''} onchange="toggleReq(${i})" style="width:auto">
      <span class="badge badge-gray">${r.cat}</span>
      <span style="flex:1;font-size:13px;${r.done?'text-decoration:line-through':''}">${r.desc}</span>
      <span class="badge ${r.done?'badge-green':'badge-yellow'}">${r.done?'Done':'Pending'}</span>
      <button class="btn btn-xs btn-danger no-print" onclick="deleteReq(${i})">Del</button>
    </div>
  `).join('');
  updateReqProgress(pt.requisitions);
}
function updateReqProgress(reqs) {
  const done = reqs.filter(r=>r.done).length;
  const total = reqs.length;
  const pct = total ? Math.round((done/total)*100) : 0;
  document.getElementById('req-pct').textContent = pct + '%';
  document.getElementById('req-progress-fill').style.width = pct + '%';
}
function toggleReq(i) { const pt = getPt(); pt.requisitions[i].done = !pt.requisitions[i].done; renderRequisitions(pt); }
function deleteReq(i) { const pt = getPt(); pt.requisitions.splice(i,1); renderRequisitions(pt); }
function addRequisition() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const cat = document.getElementById('req-cat').value;
  const desc = document.getElementById('req-desc').value.trim();
  if (!desc) { toast('Enter task description'); return; }
  pt.requisitions.push({cat, desc, done: false});
  document.getElementById('req-desc').value = '';
  renderRequisitions(pt);
  toast('Task added');
}

// ===================== CHARGES =====================
function fillCharge() {
  const val = document.getElementById('charge-cpt').value;
  if (!val) return;
  const [code, desc, amt] = val.split('|');
  document.getElementById('charge-desc').value = desc;
  document.getElementById('charge-amount').value = parseFloat(amt).toFixed(2);
}
function renderCharges(pt) {
  const el = document.getElementById('charges-list');
  if (!pt || !pt.charges.length) { el.innerHTML = '<p class="text-muted text-sm">No charges yet.</p>'; document.getElementById('charges-total').textContent = '0.00'; return; }
  let total = 0;
  el.innerHTML = `<table><thead><tr><th>Source</th><th>Code</th><th>Description</th><th>Amount</th><th class="no-print">Action</th></tr></thead><tbody>
  ${pt.charges.map((c,i) => { total += c.amount; return `<tr>
    <td><span class="badge ${c.manual ? 'badge-yellow' : 'badge-blue'}">${c.manual ? 'Manual' : 'List'}</span></td>
    <td class="font-mono">${c.code}</td>
    <td>${c.desc}</td>
    <td class="font-mono">$${c.amount.toFixed(2)}</td>
    <td class="no-print"><button class="btn btn-xs btn-danger" onclick="deleteCharge(${i})">Del</button></td>
  </tr>`; }).join('')}
  </tbody></table>`;
  document.getElementById('charges-total').textContent = total.toFixed(2);
}
function addCharge() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const cptVal = document.getElementById('charge-cpt').value;
  const desc = document.getElementById('charge-desc').value.trim();
  const amount = parseFloat(document.getElementById('charge-amount').value);
  if (!desc || isNaN(amount) || amount <= 0) { toast('Enter valid charge details'); return; }
  const code = cptVal ? cptVal.split('|')[0] : 'CUSTOM';
  pt.charges.push({code, desc, amount, manual: false});
  document.getElementById('charge-cpt').value = '';
  document.getElementById('charge-desc').value = '';
  document.getElementById('charge-amount').value = '';
  renderCharges(pt);
  toast('Charge added');
}
function addManualCharge() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  const codeType = document.getElementById('manual-code-type').value;
  const code = document.getElementById('manual-code').value.trim();
  const desc = document.getElementById('manual-desc').value.trim();
  const amount = parseFloat(document.getElementById('manual-amount').value);
  if (!code || !desc || isNaN(amount) || amount <= 0) { toast('Enter code, description, and a valid amount'); return; }
  pt.charges.push({code: `[${codeType}] ${code}`, desc, amount, manual: true});
  document.getElementById('manual-code').value = '';
  document.getElementById('manual-desc').value = '';
  document.getElementById('manual-amount').value = '';
  renderCharges(pt);
  toast('Manual charge added');
}
function deleteCharge(i) { const pt = getPt(); pt.charges.splice(i,1); renderCharges(pt); toast('Charge removed'); }

// ===================== CHECKOUT =====================
function renderCheckout(pt) {
  const el = document.getElementById('checkout-content');
  if (!pt) { el.innerHTML = '<p class="text-muted">Select a patient.</p>'; return; }
  const total = pt.charges.reduce((s,c) => s + c.amount, 0);
  const remaining_ded = Math.max(0, pt.deductible - pt.deductibleMet);
  const ded_applied = Math.min(remaining_ded, total);
  const after_ded = total - ded_applied;
  const ins_rate = 0.80;
  const ins_pays = Math.round(after_ded * ins_rate * 100) / 100;
  const pt_base = Math.round((after_ded * (1 - ins_rate)) * 100) / 100;
  const pt_responsibility = pt_base + pt.copay + ded_applied;
  const tax = Math.round(pt_responsibility * 0.08 * 100) / 100;
  const total_due = pt_responsibility + tax;

  // Build dynamic billing explanation based on patient's deductible situation
  let billingExplanation = '';
  if (pt.deductible === 0) {
    billingExplanation = `
      <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#047857;margin-bottom:10px">üìö How This Bill Was Calculated</div>
        <div style="font-size:13px;color:#1a2b3c;line-height:1.8">
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">1</span><strong>No deductible applies</strong> ‚Äî ${pt.insurance} covers this patient with no annual deductible requirement.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">2</span>Total charges of <strong>$${total.toFixed(2)}</strong> go directly to the 80/20 insurance split.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">3</span><strong>Insurance pays 80%</strong> = $${ins_pays.toFixed(2)} &nbsp;|&nbsp; <strong>Patient pays 20%</strong> = $${pt_base.toFixed(2)}</div>
          ${pt.copay > 0 ? `<div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">4</span>A <strong>$${pt.copay.toFixed(2)} copay</strong> is added to the patient's share.</div>` : ''}
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid #86efac;font-size:12px;color:#047857"><strong>üí° Key concept:</strong> When there is no deductible, the 80/20 split applies to the full visit charge from the first dollar.</div>
        </div>
      </div>`;
  } else if (remaining_ded === 0) {
    billingExplanation = `
      <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#047857;margin-bottom:10px">üìö How This Bill Was Calculated</div>
        <div style="font-size:13px;color:#1a2b3c;line-height:1.8">
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">1</span><strong>Deductible fully met</strong> ‚Äî ${pt.fname} has already paid the full $${pt.deductible.toFixed(2)} deductible this year. No more deductible applies to this visit.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">2</span>The full <strong>$${total.toFixed(2)}</strong> goes directly to the 80/20 insurance split.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">3</span><strong>Insurance pays 80%</strong> = $${ins_pays.toFixed(2)} &nbsp;|&nbsp; <strong>Patient pays 20%</strong> = $${pt_base.toFixed(2)}</div>
          ${pt.copay > 0 ? `<div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#047857;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">4</span>A <strong>$${pt.copay.toFixed(2)} copay</strong> is added to the patient's share.</div>` : ''}
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid #86efac;font-size:12px;color:#047857"><strong>üí° Key concept:</strong> Once the annual deductible is fully met, the patient only pays their coinsurance percentage (20%) for the rest of the plan year.</div>
        </div>
      </div>`;
  } else if (ded_applied < remaining_ded) {
    // Visit total is less than what's remaining on the deductible ‚Äî patient pays full visit
    billingExplanation = `
      <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#92400e;margin-bottom:10px">üìö How This Bill Was Calculated</div>
        <div style="font-size:13px;color:#1a2b3c;line-height:1.8">
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#92400e;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">1</span>${pt.fname} has a <strong>$${pt.deductible.toFixed(2)} annual deductible</strong>. So far this year, <strong>$${pt.deductibleMet.toFixed(2)}</strong> has been met. That leaves <strong>$${remaining_ded.toFixed(2)}</strong> still owed before insurance begins sharing costs.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#92400e;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">2</span>Today's visit total of <strong>$${total.toFixed(2)}</strong> is less than the remaining deductible of $${remaining_ded.toFixed(2)}, so the <strong>entire visit cost applies to the deductible</strong>. Insurance does not pay anything yet.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#92400e;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">3</span>Patient pays <strong>$${ded_applied.toFixed(2)}</strong> (full visit cost) toward deductible. After today, <strong>$${(remaining_ded - ded_applied).toFixed(2)}</strong> will remain on the deductible.</div>
          ${pt.copay > 0 ? `<div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#92400e;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">4</span>A <strong>$${pt.copay.toFixed(2)} copay</strong> is added to the patient's total.</div>` : ''}
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid #fcd34d;font-size:12px;color:#92400e"><strong>üí° Key concept:</strong> When the visit total is less than the remaining deductible, the patient pays 100% of the visit. Insurance only begins paying after the full deductible amount has been satisfied.</div>
        </div>
      </div>`;
  } else {
    // Visit total exceeds remaining deductible ‚Äî patient pays remainder then 20%
    billingExplanation = `
      <div style="background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#1e40af;margin-bottom:10px">üìö How This Bill Was Calculated</div>
        <div style="font-size:13px;color:#1a2b3c;line-height:1.8">
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#1e40af;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">1</span>${pt.fname} has a <strong>$${pt.deductible.toFixed(2)} annual deductible</strong>. So far this year, <strong>$${pt.deductibleMet.toFixed(2)}</strong> has been met. That leaves <strong>$${remaining_ded.toFixed(2)}</strong> remaining before insurance begins sharing costs.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#1e40af;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">2</span>The first <strong>$${ded_applied.toFixed(2)}</strong> of today's $${total.toFixed(2)} visit goes toward satisfying the remaining deductible. The patient pays this portion in full ‚Äî insurance does not cover it.</div>
          <div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#1e40af;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">3</span>The remaining <strong>$${after_ded.toFixed(2)}</strong> is now subject to the 80/20 split: <strong>Insurance pays 80%</strong> = $${ins_pays.toFixed(2)} &nbsp;|&nbsp; <strong>Patient pays 20%</strong> = $${pt_base.toFixed(2)}</div>
          ${pt.copay > 0 ? `<div style="margin-bottom:6px"><span style="display:inline-block;width:20px;height:20px;background:#1e40af;color:#fff;border-radius:50%;text-align:center;font-size:11px;font-weight:700;line-height:20px;margin-right:8px">4</span>A <strong>$${pt.copay.toFixed(2)} copay</strong> is added to the patient's share.</div>` : ''}
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid #93c5fd;font-size:12px;color:#1e40af"><strong>üí° Key concept:</strong> When a visit straddles the deductible, the patient pays 100% up to the deductible balance, then only their 20% coinsurance on the remainder. Two different rules apply in the same visit.</div>
        </div>
      </div>`;
  }

  el.innerHTML = `
    ${billingExplanation}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-title">Patient & Insurance</div>
        <div class="field-group mb-8"><div class="field-label">Patient</div><div class="field-value">${pt.fname} ${pt.lname}</div></div>
        <div class="field-group mb-8"><div class="field-label">Insurance</div><div class="field-value">${pt.insurance}</div></div>
        <div class="field-group mb-8"><div class="field-label">Member ID</div><div class="field-value font-mono">${pt.insId}</div></div>
        <div class="field-group mb-8"><div class="field-label">Annual Deductible</div><div class="field-value">$${pt.deductible.toFixed(2)}</div></div>
        <div class="field-group mb-8"><div class="field-label">Deductible Met</div><div class="field-value">$${pt.deductibleMet.toFixed(2)}</div></div>
        <div class="field-group"><div class="field-label">Copay</div><div class="field-value">$${pt.copay.toFixed(2)}</div></div>
      </div>
      <div class="card">
        <div class="card-title">Billing Summary</div>
        <div class="checkout-row"><span>Total Charges</span><span class="font-mono">$${total.toFixed(2)}</span></div>
        <div class="checkout-row"><span>Deductible Applied</span><span class="font-mono">$${ded_applied.toFixed(2)}</span></div>
        <div class="checkout-row"><span>Insurance Responsibility (80%)</span><span class="font-mono">$${ins_pays.toFixed(2)}</span></div>
        <div class="checkout-row"><span>Copay</span><span class="font-mono">$${pt.copay.toFixed(2)}</span></div>
        <div class="checkout-row"><span>Patient Base Responsibility</span><span class="font-mono">$${pt_responsibility.toFixed(2)}</span></div>
        <div class="checkout-row"><span>Tax (8%)</span><span class="font-mono">$${tax.toFixed(2)}</span></div>
        <div class="checkout-row total"><span>TOTAL DUE</span><span class="font-mono" style="color:var(--primary)">$${total_due.toFixed(2)}</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Payment</div>
      <div class="form-row">
        <div class="form-group">
          <label>Payment Method</label>
          <select id="payment-method">
            <option>Credit Card</option><option>Debit Card</option>
            <option>Insurance Claim</option><option>Cash</option><option>Check</option>
            <option>Payment Plan</option>
          </select>
        </div>
        <div class="form-group" style="justify-content:flex-end;align-items:flex-end">
          <button class="btn btn-success" style="width:200px" onclick="finalCheckout(${total_due.toFixed(2)})">
            üí≥ Complete Payment ‚Äî $${total_due.toFixed(2)}
          </button>
        </div>
      </div>
      <div id="checkout-confirm"></div>
    </div>
  `;
}

function finalCheckout(amount) {
  const pt = getPt(); if (!pt) return;
  const method = document.getElementById('payment-method').value;
  const el = document.getElementById('checkout-confirm');
  el.innerHTML = `
    <div style="background:#d4f8ed;border:1px solid var(--green);border-radius:8px;padding:14px;margin-top:12px">
      <div style="font-weight:700;color:#047857;font-size:16px;margin-bottom:6px">‚úì Payment Processed</div>
      <div>Amount: <b class="font-mono">$${amount}</b> via ${method}</div>
      <div>Patient: ${pt.fname} ${pt.lname}</div>
      <div>Date: ${ts()}</div>
      <div style="margin-top:8px"><button class="btn btn-sm btn-secondary no-print" onclick="doCheckout()">Check Out Patient</button></div>
    </div>`;
  toast('Payment of $' + amount + ' processed');
}

// ===================== ADD PATIENT MODAL =====================
function showAddPatientModal() {
  document.getElementById('modal-overlay').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}
function saveNewPatient() {
  const fname = document.getElementById('np-fname').value.trim();
  const lname = document.getElementById('np-lname').value.trim();
  const dob = document.getElementById('np-dob').value;
  const gender = document.getElementById('np-gender').value;
  const phone = document.getElementById('np-phone').value.trim();
  const insurance = document.getElementById('np-ins').value.trim();
  const address = document.getElementById('np-addr').value.trim();
  if (!fname || !lname || !dob) { toast('Name and DOB required'); return; }
  const id = 'MRN' + String(patients.length + 1).padStart(5, '0');
  const newPt = {
    id, fname, lname, dob, gender, phone, address,
    insurance: insurance || 'Self-pay', insId: 'SELF-001', copay: 0, deductible: 0, deductibleMet: 0,
    checkedIn: false, allergies: [], meds: [], problems: [], vitalsHistory: [],
    visitHistory: [], notes: [], orders: [], labProcs: [], appointments: [],
    encounter: {cc:'',hpi:'',ap:''}, requisitions: [], charges: []
  };
  patients.push(newPt);
  const sel = document.getElementById('patient-select');
  const o = document.createElement('option');
  o.value = id;
  o.text = `${fname} ${lname} (${calcAge(dob)} y/o) ‚Äî ${id}`;
  sel.add(o);
  sel.value = id;
  selectPatient(id);
  closeModal();
  toast('New patient added: ' + fname + ' ' + lname);
  ['np-fname','np-lname','np-dob','np-phone','np-ins','np-addr'].forEach(id => document.getElementById(id).value = '');
}

// ===================== PRINT =====================
function printRecord() {
  const pt = getPt(); if (!pt) { toast('Select a patient to print'); return; }
  // Make all sections visible for printing then restore
  const sections = document.querySelectorAll('.section');
  sections.forEach(s => s.style.display = 'block');
  // Render all sections
  ['patient-details','visit-history','problem-list','vital-signs','allergies-meds','clinical-notes','orders','lab-results','lab-procedures','appointments','encounter-form','requisitions','visit-charges','checkout'].forEach(n => renderSection(n));
  window.print();
  setTimeout(() => {
    sections.forEach(s => s.style.display = '');
    document.querySelector('.section.active') && (document.querySelector('.section.active').style.display = 'block');
    // Clear checkout after printing so it doesn't bleed into the visible UI
    document.getElementById('checkout-content').innerHTML = '<p class="text-muted">Select a patient to view checkout.</p>';
  }, 500);
}

// ===================== TOAST =====================
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.innerHTML = msg;
  el.style.background = type === 'info' ? '#1a6bb5' : 'var(--primary-dark)';
  el.style.maxWidth = type === 'info' ? '340px' : '300px';
  el.style.lineHeight = type === 'info' ? '1.6' : '1.4';
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), type === 'info' ? 8000 : 2800);
}

// ===================== CLOSE MODAL ON OVERLAY CLICK =====================
document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>

<!-- EDIT PATIENT MODAL -->
<div id="edit-patient-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:28px;width:580px;max-width:95vw;max-height:90vh;overflow-y:auto">
    <h3 style="margin-bottom:16px;font-size:18px">‚úè Edit Patient Details</h3>
    <div class="form-row">
      <div class="form-group"><label>First Name</label><input id="ep-fname"></div>
      <div class="form-group"><label>Last Name</label><input id="ep-lname"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Date of Birth</label><input id="ep-dob" type="date"></div>
      <div class="form-group"><label>Gender</label><select id="ep-gender"><option>Male</option><option>Female</option><option>Non-binary</option><option>Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Guardian (if applicable)</label><input id="ep-guardian" placeholder="Guardian name"></div>
      <div class="form-group"><label>Phone</label><input id="ep-phone"></div>
    </div>
    <div class="form-group" style="margin-bottom:12px"><label>Address</label><input id="ep-address"></div>
    <div style="background:var(--surface2);border-radius:8px;padding:14px;margin-bottom:12px">
      <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Insurance</div>
      <div class="form-row">
        <div class="form-group" style="flex:2"><label>Insurance Provider</label><input id="ep-insurance"></div>
        <div class="form-group"><label>Member ID</label><input id="ep-insid"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Copay ($)</label><input id="ep-copay" type="number" step="0.01"></div>
        <div class="form-group"><label>Annual Deductible ($)</label><input id="ep-deductible" type="number" step="0.01"></div>
        <div class="form-group"><label>Deductible Met ($)</label><input id="ep-deductiblemet" type="number" step="0.01"></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeEditPatientModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditPatient()">üíæ Save Changes</button>
    </div>
  </div>
</div>
<script>
  document.getElementById('edit-patient-modal').addEventListener('click', function(e) {
    if (e.target === this) closeEditPatientModal();
  });

// ===================== PEDIATRIC ENCOUNTER =====================

const PEDIATRIC_PIDS = [0, 1, 2]; // Ethan, Lily, Jamal (index in patients array)

const PED_MILESTONES = {
  5: [
    {cat:'Gross Motor', items:['Hops on one foot','Skips','Catches a bounced ball']},
    {cat:'Fine Motor', items:['Draws a person with body','Copies a triangle','Uses scissors well']},
    {cat:'Language', items:['Speaks in full sentences','Tells simple stories','Names basic colors/numbers']},
    {cat:'Social/Emotional', items:['Follows rules in games','Distinguishes real vs make-believe','Shows independence']}
  ],
  9: [
    {cat:'Gross Motor', items:['Rides a bike','Coordinates in team sports','Good balance and agility']},
    {cat:'Fine Motor', items:['Writes neatly','Uses tools skillfully','Detailed drawings']},
    {cat:'Language', items:['Reads chapter books','Understands complex instructions','Strong vocabulary']},
    {cat:'Social/Emotional', items:['Has close friendships','Understands fairness','Can problem-solve conflicts']}
  ],
  15: [
    {cat:'Physical', items:['Puberty progression appropriate','Adequate sleep 8-10hr/night','Regular physical activity']},
    {cat:'Cognitive', items:['Abstract reasoning developing','Plans for future','Understands consequences']},
    {cat:'Social/Emotional', items:['Forming identity','Peer relationships primary','Appropriate autonomy-seeking']},
    {cat:'Safety', items:['Seatbelt use discussed','Substance use screen done','Safe dating/relationships discussed']}
  ]
};

const PED_IMMUNIZATIONS = {
  5: ['DTaP (5th dose)','MMR (2nd dose)','Varicella (2nd dose)','IPV (4th dose)','Influenza (annual)'],
  9: ['Influenza (annual)','HPV series (if starting)','Tdap (if not given)','Meningococcal (if indicated)'],
  15: ['HPV series (complete)','Tdap (booster if needed)','Meningococcal MenACWY','Influenza (annual)','COVID-19 (up to date)','Meningococcal B (discuss)']
};

const PEDIATRIC_IDS = [];

function isPediatric(pt) {
  if (!pt) return false;
  const age = calcAge(pt.dob);
  return age < 18;
}

function switchEncTab(tab) {
  document.getElementById('enc-standard').style.display = tab === 'standard' ? 'block' : 'none';
  document.getElementById('enc-pediatric').style.display = tab === 'pediatric' ? 'block' : 'none';
  document.getElementById('enc-tab-standard').classList.toggle('active', tab === 'standard');
  document.getElementById('enc-tab-pediatric').classList.toggle('active', tab === 'pediatric');
  if (tab === 'pediatric') {
    setTimeout(function() {
      loadPedMilestones();
      loadPedImmunizations();
      loadPedFeeding();
    }, 50);
  }
}

function loadPedMilestones() {
  const pt = getPt(); if (!pt) return;
  const age = calcAge(pt.dob);
  const grid = document.getElementById('ped-milestones-grid');
  if (!grid) return;
  // Find closest age set
  const ages = Object.keys(PED_MILESTONES).map(Number);
  const closest = ages.reduce((a,b) => Math.abs(b-age) < Math.abs(a-age) ? b : a);
  const milestones = PED_MILESTONES[closest];
  grid.innerHTML = milestones.map(cat => `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
      <div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">${cat.cat}</div>
      ${cat.items.map(item => `
        <label style="display:flex;align-items:flex-start;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer">
          <input type="checkbox" style="margin-top:2px;flex-shrink:0">
          <span>${item}</span>
        </label>`).join('')}
    </div>`).join('');
}

function loadPedImmunizations() {
  const pt = getPt(); if (!pt) return;
  const age = calcAge(pt.dob);
  const grid = document.getElementById('ped-immunization-grid');
  if (!grid) return;
  const ages = Object.keys(PED_IMMUNIZATIONS).map(Number);
  const closest = ages.reduce((a,b) => Math.abs(b-age) < Math.abs(a-age) ? b : a);
  const vaxList = PED_IMMUNIZATIONS[closest];
  grid.innerHTML = vaxList.map(vax => `
    <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--surface2)">
      <input type="checkbox">
      <span>${vax}</span>
    </label>`).join('');
}

function loadPedFeeding() {
  const pt = getPt(); if (!pt) return;
  const age = calcAge(pt.dob);
  const section = document.getElementById('ped-feeding-section');
  if (!section) return;
  if (age < 2) {
    section.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="radio" name="ped-feed" value="Breastfeeding"> Breastfeeding</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="radio" name="ped-feed" value="Formula"> Formula feeding</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="radio" name="ped-feed" value="Mixed"> Mixed feeding</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="radio" name="ped-feed" value="Solids introduced"> Solids introduced</label>
      </div>`;
  } else {
    section.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-fruits-veg"> Fruits & vegetables daily</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-dairy"> Adequate dairy / calcium</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-protein"> Adequate protein</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="ped-limit-sugar"> Limiting sugary drinks / snacks</label>
      </div>`;
  }
}

function addPedVax() {
  const name = document.getElementById('ped-vax-name').value.trim();
  const lot = document.getElementById('ped-vax-lot').value.trim();
  const site = document.getElementById('ped-vax-site').value;
  if (!name) { toast('Enter vaccine name'); return; }
  const list = document.getElementById('ped-vax-list');
  const entry = document.createElement('div');
  entry.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border);font-size:13px';
  entry.innerHTML = `<span style="flex:2;font-weight:600">${name}</span><span style="flex:1;color:var(--text2)">Lot: ${lot||'‚Äî'}</span><span style="flex:1;color:var(--text2)">${site}</span><button class="btn btn-xs btn-danger no-print" onclick="this.parentElement.remove()">Del</button>`;
  list.appendChild(entry);
  document.getElementById('ped-vax-name').value = '';
  document.getElementById('ped-vax-lot').value = '';
  toast('Vaccine added');
}

function savePedEncounter() {
  const pt = getPt(); if (!pt) { toast('Select a patient'); return; }
  if (!pt.pedEncounter) pt.pedEncounter = {};
  pt.pedEncounter.cc = document.getElementById('ped-cc').value;
  pt.pedEncounter.hpi = document.getElementById('ped-hpi').value;
  pt.pedEncounter.ap = document.getElementById('ped-ap').value;
  pt.pedEncounter.visitType = document.getElementById('ped-visit-type').value;
  pt.pedEncounter.parentConcern = document.getElementById('ped-parent-concern').value;
  pt.pedEncounter.htPct = document.getElementById('ped-ht-pct').value;
  pt.pedEncounter.wtPct = document.getElementById('ped-wt-pct').value;
  pt.pedEncounter.bmiPct = document.getElementById('ped-bmi-pct').value;
  pt.pedEncounter.devNotes = document.getElementById('ped-dev-notes').value;
  pt.pedEncounter.immNotes = document.getElementById('ped-imm-notes').value;
  pt.pedEncounter.nutritionNotes = document.getElementById('ped-nutrition-notes').value;
  pt.pedEncounter.nextVisit = document.getElementById('ped-next-visit').value;
  toast('Pediatric encounter saved ‚úì');
}

function initPedTab(pt) {
  const tabRow = document.getElementById('enc-tab-row');
  const pedTab = document.getElementById('enc-tab-pediatric');
  if (!tabRow || !pedTab) return;
  if (isPediatric(pt)) {
    pedTab.style.display = 'inline-flex';
    // Update the patient label banner
    const lbl = document.getElementById('ped-patient-label');
    if (lbl) lbl.textContent = pt.fname + ' ' + pt.lname + ' ¬∑ Age ' + calcAge(pt.dob) + ' ¬∑ ' + (calcAge(pt.dob) < 2 ? 'Infant' : calcAge(pt.dob) < 13 ? 'Pediatric' : 'Adolescent') + ' Visit';
    // Auto-switch to pediatric tab
    switchEncTab('pediatric');
  } else {
    pedTab.style.display = 'none';
    switchEncTab('standard');
  }
}

// BMI percentile category label
document.addEventListener('input', function(e) {
  if (e.target.id === 'ped-bmi-pct') {
    const pct = parseInt(e.target.value);
    const cat = document.getElementById('ped-bmi-cat');
    if (!cat || isNaN(pct)) return;
    if (pct < 5) { cat.textContent='Underweight'; cat.style.background='#dbeafe'; cat.style.color='#1e40af'; }
    else if (pct < 85) { cat.textContent='Healthy weight'; cat.style.background='#d4f8ed'; cat.style.color='#047857'; }
    else if (pct < 95) { cat.textContent='Overweight'; cat.style.background='#fef9c3'; cat.style.color='#92400e'; }
    else { cat.textContent='Obese'; cat.style.background='#fee2e8'; cat.style.color='#9f1239'; }
  }
});

</script>
</body>
</html>
